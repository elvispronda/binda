<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard - Fuel Log Management</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script>
    tailwind.config = { darkMode: 'class' }
  </script>
  <style>
    .modal { transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out; }
    .modal.hidden { visibility: hidden; opacity: 0; }
    .modal:not(.hidden) { visibility: visible; opacity: 1; }
    .dark .modal-content { box-shadow: 0 20px 25px -5px rgba(0,0,0,0.5), 0 10px 10px -5px rgba(0,0,0,0.2); }
    .date-filter-btn.active { background-color: #3b82f6; color: white; }
    .dark .date-filter-btn.active { background-color: #60a5fa; }
    .view-detail-label { font-weight: 500; color: #4b5563; }
    .dark .view-detail-label { color: #d1d5db; }
    .view-detail-value { color: #1f2937; }
    .dark .view-detail-value { color: #f9fafb; }
  </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-white">

<!-- Main application wrapper -->
<div class="flex h-screen">

    <!-- Sidebar (Left) - Modified for responsiveness -->
    <aside id="sidebar" class="fixed inset-y-0 left-0 z-40 w-64 bg-white dark:bg-gray-800/95 backdrop-blur-sm p-4 space-y-6 shadow-lg 
                             transform -translate-x-full transition-transform duration-300 ease-in-out 
                             md:relative md:translate-x-0 md:shadow-lg md:border-r dark:border-gray-700 
                             flex flex-col flex-shrink-0">
      <div class="flex justify-between items-center">
        <div class="text-2xl font-bold flex items-center space-x-2 text-primary dark:text-primary-light">
          <i data-lucide="command" class="w-7 h-7"></i><span>FleetDash</span>
        </div>
        <!-- Close button for mobile sidebar -->
        <button id="sidebar-close-button" class="md:hidden text-gray-700 dark:text-gray-300 p-1 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">
          <i data-lucide="x" class="w-6 h-6"></i>
        </button>
      </div>
      <nav class="flex-1 overflow-y-auto">
        <ul class="space-y-2">
            <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors">
              <i data-lucide="layout-dashboard" class="w-5 h-5"></i><a href="dashboard">Dashboard</a>
            </li>
            <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors">
              <i data-lucide="pie-chart" class="w-5 h-5"></i><a href="analytics">Analytics</a>
            </li>
            <!--li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors">
              <i data-lucide="users" class="w-5 h-5"></i><a href="users">User</a>
            </!li-->
            <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors">
              <i data-lucide="user" class="w-5 h-5"></i><a href="driver">Driver</a>
            </li>
            <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors">
              <i data-lucide="alert-triangle" class="w-5 h-5"></i><a href="panne">Pannes (Issues)</a>
            </li>
            <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors">
              <i data-lucide="car" class="w-5 h-5"></i><a href="vehicle">Vehicles</a>
            </li>
            <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors">
              <i data-lucide="wrench" class="w-5 h-5"></i><a href="reparation">Reparation</a>
            </li>
            <li class="flex items-center space-x-3 text-blue-600 dark:text-blue-400 font-semibold bg-blue-50 dark:bg-gray-700 p-2 rounded-md transition-colors">
              <i data-lucide="droplet" class="w-5 h-5"></i><a href="fuel">Fuel</a>
            </li>
            <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors">
              <i data-lucide="settings" class="w-5 h-5"></i><a href="maintenance">Maintenance</a>
            </li>
            <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors">
              <i data-lucide="route" class="w-5 h-5"></i><a href="trip">Trip</a>
            </li>
        </ul>
      </nav>
       <div class="pt-4 border-t border-gray-200 dark:border-gray-700/50 mt-auto">
            <a href="#" id="global-logout-btn" class="flex items-center space-x-3 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700/40 p-2.5 rounded-lg transition-colors">
                <i data-lucide="log-out" class="w-5 h-5"></i><span>Logout</span>
            </a>
       </div>
    </aside>

    <!-- Overlay for mobile menu -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden"></div>
    
    <!-- Content Area Wrapper (Header + Main Content + Right Sidebar) -->
    <div class="flex-1 flex flex-col overflow-hidden">
      
      <!-- Header (Mobile Hamburger, Desktop Title, Theme Toggle, User Info) -->
      <header class="bg-white dark:bg-gray-800 shadow p-3 flex justify-between items-center flex-shrink-0 h-16">
          <!-- Hamburger Menu Button - visible only on mobile -->
          <button id="mobile-menu-button" class="md:hidden text-gray-700 dark:text-gray-300 focus:outline-none p-2">
              <i data-lucide="menu" class="w-6 h-6"></i>
          </button>
          
          <!-- Mobile Title - visible only on mobile -->
          <div class="text-lg font-bold text-primary dark:text-primary-light md:hidden">
              FleetDash
          </div>

          <!-- Desktop Title/Context - hidden on mobile -->
          <div class="hidden md:block text-xl font-semibold text-gray-700 dark:text-gray-200">
              Fuel Log Management
          </div>
          
          <!-- Right side of header: Theme Toggle & User Info -->
          <div class="flex items-center space-x-3">
              <button id="theme-toggle-header" class="text-xl p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300">
                  <!-- Icon will be set by JS -->
              </button>
              <!-- User info for desktop header - hidden on mobile -->
              <div class="hidden md:flex items-center space-x-2">
                  <div class="text-sm font-semibold" id="userDisplayNameHeader">User</div>
                  <div class="text-xs text-gray-500 dark:text-gray-400">Admin</div>
              </div>
          </div>
      </header>

      <!-- Main scrollable content area (Main Page Content + Right Sidebar) -->
      <div class="flex-1 flex overflow-hidden">
        <main class="flex-1 overflow-y-auto p-6">
          <section id="fuel-section" class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow mb-6">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-3">
              <div class="flex flex-wrap gap-2 items-center">
                <button id="openAddFuelModalButton" class="bg-blue-500 text-white px-3 py-2 rounded-lg hover:bg-blue-600 flex items-center gap-1 text-sm shadow-sm">
                  <i data-lucide="plus" class="w-4 h-4"></i> Add Fuel Log
                </button>
                 <select id="fuelVehicleFilter" class="border dark:border-gray-600 rounded-lg px-3 py-2 text-sm text-black dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent w-full sm:w-auto">
                      <option value="">All Vehicles</option>
                  </select>
                  <select id="fuelFuelTypeFilter" class="border dark:border-gray-600 rounded-lg px-3 py-2 text-sm text-black dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent w-full sm:w-auto">
                      <option value="">All Fuel Types</option>
                  </select>
              </div>
              <div class="flex flex-wrap gap-2 items-center">
                <button id="exportExcelButton" class="bg-green-500 text-white px-3 py-2 rounded-lg hover:bg-green-600 text-sm shadow-sm">ðŸ“„ Excel</button>
                <button id="exportPdfButton" class="bg-red-500 text-white px-3 py-2 rounded-lg hover:bg-red-600 text-sm shadow-sm">ðŸ§¾ PDF</button>
              </div>
            </div>

            <div class="mb-4 flex flex-wrap items-center gap-2">
              <span class="text-sm font-medium mr-2">Filter by Date Recorded:</span>
              <button id="fuel-filter-today" class="date-filter-btn px-3 py-1.5 text-sm border dark:border-gray-600 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">Today</button>
              <button id="fuel-filter-last7" class="date-filter-btn px-3 py-1.5 text-sm border dark:border-gray-600 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">Last 7 Days</button>
              <button id="fuel-filter-last30" class="date-filter-btn px-3 py-1.5 text-sm border dark:border-gray-600 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">Last 30 Days</button>
              <button id="fuel-filter-all" class="date-filter-btn px-3 py-1.5 text-sm border dark:border-gray-600 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 active">All Time</button>
              <button id="fuel-filter-custom-btn" class="date-filter-btn px-3 py-1.5 text-sm border dark:border-gray-600 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">Custom Range</button>
            </div>
            <div id="fuelCustomDateRange" class="mb-4 hidden items-center gap-2 p-3 border dark:border-gray-700 rounded-md bg-gray-50 dark:bg-gray-800/50">
              <input type="date" id="fuelCustomStartDate" class="border dark:border-gray-600 rounded-md px-2 py-1.5 text-sm text-black dark:bg-gray-700 dark:text-white">
              <span class="text-sm">to</span>
              <input type="date" id="fuelCustomEndDate" class="border dark:border-gray-600 rounded-md px-2 py-1.5 text-sm text-black dark:bg-gray-700 dark:text-white">
              <button id="applyCustomDateFilterButton" class="bg-blue-500 text-white px-3 py-1.5 text-sm rounded-md hover:bg-blue-600">Apply</button>
            </div>

            <div class="overflow-x-auto">
              <table id="fuelLogTable" class="w-full text-left text-sm">
                <thead>
                  <tr class="border-b dark:border-gray-700">
                    <th class="py-3 px-2 font-semibold">ID</th>
                    <th class="px-2 font-semibold">Vehicle (Plate)</th>
                    <th class="px-2 font-semibold">Fuel Type</th>
                    <th class="px-2 font-semibold text-right">Quantity</th>
                    <th class="px-2 font-semibold text-right">Price/Unit ($)</th>
                    <th class="px-2 font-semibold text-right">Total Cost ($)</th>
                    <th class="px-2 font-semibold">Date Recorded</th>
                    <th class="px-2 font-semibold text-center">Actions</th>
                  </tr>
                </thead>
                <tbody id="fuelLogBody"></tbody>
              </table>
            </div>
            <div class="mt-6 flex flex-col sm:flex-row justify-between items-center space-y-3 sm:space-y-0">
              <div class="text-sm text-gray-600 dark:text-gray-400" id="fuelLogCount"></div>
              <div class="flex items-center space-x-1" id="fuelLogPagination"></div>
            </div>
          </section>
        </main>
         <!-- Right Sidebar -->
         <aside class="w-1/5 bg-white dark:bg-gray-800/95 backdrop-blur-sm p-4 space-y-6 shadow-lg hidden lg:block flex-shrink-0 border-l dark:border-gray-700 overflow-y-auto">
            <div class="flex justify-end items-center">
                <div class="text-right">
                    <div class="text-sm font-semibold text-gray-800 dark:text-white" id="userDisplayNameRightSidebar">User</div>
                    <div class="text-xs text-gray-500 dark:text-gray-400">Fleet Analyst</div>
                </div>
                <img src="https://i.pravatar.cc/40?u=analyst_jane_doe" alt="Analyst" class="w-10 h-10 rounded-full ml-2 object-cover">
            </div>
            <hr class="dark:border-gray-700/50">
            <div>
                <h4 class="font-semibold mb-3 text-gray-700 dark:text-gray-200">Key Performance Insights</h4>
                <ul id="keyPerformanceInsightsList" class="text-xs space-y-2.5 text-gray-600 dark:text-gray-300">
                    <li class="flex items-start space-x-2"><i data-lucide="loader-2" class="w-4 h-4 text-gray-400 animate-spin mt-0.5 shrink-0"></i><span>Loading insights...</span></li>
                </ul>
            </div>
            <hr class="dark:border-gray-700/50">
            <div>
                <div class="flex justify-between items-center mb-3">
                    <h4 class="font-semibold text-gray-700 dark:text-gray-200">Alerts & Notifications</h4>
                    <a href="#" id="viewAllNotificationsLink" class="text-xs text-primary dark:text-primary-light hover:underline">View All (<span id="notificationCount">0</span>)</a>
                </div>
                <div id="notificationsList" class="space-y-3 max-h-40 overflow-y-auto pr-1">
                     <div class="flex items-start space-x-2 p-2.5 bg-gray-100 dark:bg-gray-700/50 rounded-lg"><i data-lucide="loader-2" class="w-5 h-5 text-gray-400 animate-spin mt-0.5 flex-shrink-0"></i><p class="text-xs text-gray-700 dark:text-gray-300">Loading alerts...</p></div>
                </div>
            </div>
        </aside>
      </div>
    </div>
</div>

<!-- Add/Edit Fuel Log Modal -->
<div id="addFuelModal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 hidden">
  <div class="modal-content bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
    <div class="p-6">
      <div class="flex justify-between items-center mb-6">
        <div>
          <h3 class="text-xl font-bold text-gray-800 dark:text-white" id="fuelModalTitle">Add New Fuel Log</h3>
          <p class="text-sm text-gray-500 dark:text-gray-400">Enter transaction details</p>
        </div>
        <button id="closeAddFuelModalButtonTop" class="p-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
          <i data-lucide="x" class="w-5 h-5 text-gray-500 dark:text-gray-400"></i>
        </button>
      </div>
      <form id="addFuelForm" class="space-y-4">
        <input type="hidden" id="fuelId_form">
        <div>
          <label for="fuel_vehicle_id_form" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Vehicle</label>
          <select id="fuel_vehicle_id_form" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white"></select>
        </div>
        <div>
          <label for="fuel_fuel_type_id_form" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Fuel Type</label>
          <select id="fuel_fuel_type_id_form" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white"></select>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="fuel_quantity_form" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Quantity (Liters/kWh)</label>
              <input type="number" step="0.01" id="fuel_quantity_form" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white" placeholder="e.g., 50.25">
            </div>
            <div>
              <label for="fuel_price_little_form" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Price per Unit ($)</label>
              <input type="number" step="0.001" id="fuel_price_little_form" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white" placeholder="e.g., 1.500">
            </div>
        </div>
        <div class="mt-2" id="calculatedCostDisplayArea" style="display: none;">
            <p class="text-sm text-gray-600 dark:text-gray-400">Estimated Total Cost: <span id="displayCalculatedCost" class="font-semibold"></span></p>
        </div>
        <div class="flex justify-end gap-3 pt-4">
          <button type="button" id="cancelAddFuelModalButton" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700">Cancel</button>
          <button type="submit" id="fuelSubmitButton" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg flex items-center gap-2">
            <i data-lucide="plus-circle" class="w-4 h-4"></i> Add Log
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- View Fuel Log Modal -->
<div id="viewFuelModal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 hidden">
  <div class="modal-content bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
    <div class="p-6">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-xl font-bold text-gray-800 dark:text-white">Fuel Log Details</h3>
        <button id="closeViewFuelModalButtonTop" class="p-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
          <i data-lucide="x" class="w-5 h-5 text-gray-500 dark:text-gray-400"></i>
        </button>
      </div>
      <div id="viewFuelDetails" class="space-y-3 text-sm">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-3">
            <div><span class="view-detail-label">Log ID:</span> <span id="view-fuel-id" class="view-detail-value"></span></div>
            <div><span class="view-detail-label">Vehicle:</span> <span id="view-fuel-vehicle" class="view-detail-value"></span></div>
            <div><span class="view-detail-label">Fuel Type:</span> <span id="view-fuel-fuel_type" class="view-detail-value"></span></div>
            <div><span class="view-detail-label">Quantity:</span> <span id="view-fuel-quantity" class="view-detail-value"></span></div>
            <div><span class="view-detail-label">Price/Unit:</span> <span id="view-fuel-price_little" class="view-detail-value"></span></div>
            <div><span class="view-detail-label">Total Cost:</span> <span id="view-fuel-cost" class="view-detail-value"></span></div>
            <div><span class="view-detail-label">Date Recorded:</span> <span id="view-fuel-created_at" class="view-detail-value"></span></div>
        </div>
      </div>
      <div class="flex justify-end pt-6">
          <button type="button" id="closeViewFuelModalButtonBottom" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-lg">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Generic Confirmation Modal -->
<div id="genericConfirmModal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 hidden">
    <div class="modal-content bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md">
        <div class="p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 id="genericConfirmModalTitle" class="text-xl font-bold text-gray-800 dark:text-white">Confirm Action</h3>
                <button id="closeGenericConfirmModalButtonX" class="p-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
                    <i data-lucide="x" class="w-5 h-5 text-gray-500 dark:text-gray-400"></i>
                </button>
            </div>
            <p id="genericConfirmModalMessage" class="text-sm text-gray-600 dark:text-gray-400 mb-6">Are you sure?</p>
            <div class="flex justify-end gap-3 pt-4">
                <button id="cancelGenericConfirmModalButton" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700">Cancel</button>
                <button id="genericConfirmModalConfirmBtn" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg flex items-center gap-2">
                  {/* Content set by JS */} Confirm
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Information/Status Modal -->
<div id="infoStatusModal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 hidden">
    <div class="modal-content bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md">
        <div class="p-6 text-center">
            <div id="infoStatusModalIconContainer" class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
              {/* Icon set by JS */}
            </div>
            <h3 id="infoStatusModalTitle" class="text-lg font-medium text-gray-900 dark:text-white mb-2">Status</h3>
            <div class="mt-2">
                <p id="infoStatusModalMessage" class="text-sm text-gray-500 dark:text-gray-400">Message.</p>
            </div>
            <div class="mt-5">
                <button type="button" id="infoStatusModalOkButton" class="w-full rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:ring-2 focus:ring-blue-500">OK</button>
            </div>
        </div>
    </div>
</div>
<script>
  const API_BASE_URL = '';
  const LOGIN_PAGE_URL = '/login';
  const FUEL_API_ENDPOINT = '/fuel/'; 
  const VEHICLE_API_ENDPOINT = '/vehicle/';
  const FUEL_TYPE_API_ENDPOINT = '/fuel_type/';

  // --- CORE HELPER FUNCTIONS ---
  function getAuthToken() { return localStorage.getItem('accessToken'); }
  function parseJwt(token) { try { return JSON.parse(atob(token.split('.')[1])); } catch (e) { console.error("JWT Parse Error:", e); return null; }}

  function updateUserInfoDisplay() {
    const token = getAuthToken();
    const userDisplayElements = [
        document.getElementById('userDisplayNameHeader'),
        document.getElementById('userDisplayNameRightSidebar')
    ];

    userDisplayElements.forEach(userDisplayElement => {
        if (!userDisplayElement) return;
        if (token) {
            const decoded = parseJwt(token);
            userDisplayElement.textContent = (decoded && decoded.sub) ? decoded.sub : 'User (Authenticated)';
        } else {
            userDisplayElement.textContent = 'Guest';
        }
    });
  }

  async function apiRequest(endpoint, method = 'GET', body = null) {
    const token = getAuthToken();
    const headers = { 'Content-Type': 'application/json' };
    
    if (token) {
        headers['Authorization'] = `Bearer ${token}`;
    } else {
        console.warn(`WARN: Protected endpoint ${endpoint} called without token.`);
    }

    const config = { method, headers };
    if (body) config.body = JSON.stringify(body);

    try {
      const response = await fetch(`${API_BASE_URL}${endpoint}`, config);
      const responseForJson = response.clone();
      const responseForText = response.clone();

      if (response.status === 401) {
        openInfoStatusModal("Authentication Error", "Session expired or unauthorized. Please log in again.", "error", 5000);
        return null;
      }
      if (response.status === 204) return true;

      const responseData = await responseForJson.json().catch(async (jsonError) => {
          const text = await responseForText.text();
          console.error(`JSON Parse Error for ${endpoint}. Status: ${response.status}. Response: ${text.substring(0,200)}...`, jsonError);
          if (!response.ok) { return Promise.reject({ status: response.status, detail: text || `Server error ${response.status}` }); }
          return Promise.reject({ status: response.status, detail: `Invalid JSON (Status: ${response.status}). Text: ${text.substring(0,100)}` });
      });

      if (!response.ok) {
        const errorDetail = responseData.detail || (typeof responseData === 'object' ? JSON.stringify(responseData) : responseData) || 'Unknown server error.';
        console.error(`API Error for ${endpoint}: ${response.status}`, errorDetail);
        openInfoStatusModal(`API Error: ${response.status}`, errorDetail, "error");
        return null;
      }
      return responseData;
    } catch (error) {
      console.error(`Network/Catch Error for ${endpoint}:`, error);
      const errorMessage = error.detail || error.message || "A network or request error occurred.";
      openInfoStatusModal("Request Error", errorMessage, "error");
      return null;
    }
  }

  // --- GLOBAL VARIABLES & STATE ---
  let allFetchedFuelLogsFromServer = [];
  let vehicleDataForDropdown_fuel = [];
  let fuelTypeDataForDropdown_fuel = [];
  const fuelLogsPerPage = 10;
  let currentFuelLogPage = 1;
  let fuelLogToEditId = null;
  let activeFuelDateFilter = 'all';
  let customFuelFilterStartDate = null;
  let customFuelFilterEndDate = null;
  let currentConfirmAction = null;
  let currentActionData = null;
  let infoStatusModalTimeout = null;

  // --- SIDEBAR & THEME ---
  const sidebar = document.getElementById('sidebar');
  const mobileMenuButton = document.getElementById('mobile-menu-button');
  const sidebarCloseButton = document.getElementById('sidebar-close-button'); 
  const sidebarOverlay = document.getElementById('sidebar-overlay');
  const themeToggleButtonHeader = document.getElementById('theme-toggle-header'); 

  function openMobileMenu() {
    if (sidebar && sidebarOverlay) {
        sidebar.classList.remove('-translate-x-full');
        sidebar.classList.add('translate-x-0');
        sidebarOverlay.classList.remove('hidden');
        document.body.classList.add('overflow-hidden', 'md:overflow-auto');
    }
  }

  function closeMobileMenu() {
    if (sidebar && sidebarOverlay) {
        sidebar.classList.add('-translate-x-full');
        sidebar.classList.remove('translate-x-0');
        sidebarOverlay.classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
    }
  }
  
  function setInitialThemeIcon() {
    if (themeToggleButtonHeader) { 
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
            themeToggleButtonHeader.innerHTML = '<i data-lucide="sun" class="w-5 h-5"></i>';
        } else {
            document.documentElement.classList.remove('dark');
            themeToggleButtonHeader.innerHTML = '<i data-lucide="moon" class="w-5 h-5"></i>';
        }
        lucide.createIcons();
    }
  }

  function toggleTheme() {
    if (document.documentElement.classList.contains('dark')) {
        document.documentElement.classList.remove('dark');
        localStorage.setItem('theme', 'light');
    } else {
        document.documentElement.classList.add('dark');
        localStorage.setItem('theme', 'dark');
    }
    setInitialThemeIcon();
  }

  // --- Dashboard Widget Functions (Right Sidebar) ---
  async function fetchAndDisplayPerformanceInsights() {
      const insightsList = document.getElementById('keyPerformanceInsightsList');
      if (!insightsList) return;

      insightsList.innerHTML = `<li class="flex items-start space-x-2"><i data-lucide="loader-2" class="w-4 h-4 text-gray-400 animate-spin mt-0.5 shrink-0"></i><span>Loading insights...</span></li>`;
      lucide.createIcons();

      const data = await apiRequest('/dashboard-data/performance-insights');
      if (!data) {
          insightsList.innerHTML = `<li class="flex items-start space-x-2 text-red-500"><i data-lucide="alert-circle" class="w-4 h-4 mt-0.5 shrink-0"></i><span>Failed to load insights.</span></li>`;
          lucide.createIcons();
          return;
      }

      let insightsHTML = '';
      const { fuel_efficiency, maintenance_compliance } = data;
      if (fuel_efficiency) {
          let trendColor = 'text-gray-500 dark:text-gray-400';
          let trendText = 'steady';
          if (fuel_efficiency.trend === 'up') {
              trendColor = 'text-green-500';
              trendText = 'improving';
          } else if (fuel_efficiency.trend === 'down') {
              trendColor = 'text-red-500';
              trendText = 'worsening';
          }
          const percentageText = fuel_efficiency.percentage_change !== null ? `(${fuel_efficiency.percentage_change > 0 ? '+' : ''}${fuel_efficiency.percentage_change}%)` : '(No prior data)';
          insightsHTML += `<li class="flex items-start space-x-2"><i data-lucide="droplet" class="w-4 h-4 text-blue-500 mt-0.5 shrink-0"></i><div><span>Fuel Efficiency is <span class="${trendColor} font-semibold">${trendText}</span>.</span><span class="block text-gray-400 dark:text-gray-500 text-xs">Consumption vs last month ${percentageText}.</span></div></li>`;
      }
      if (maintenance_compliance) {
          insightsHTML += `<li class="flex items-start space-x-2"><i data-lucide="wrench" class="w-4 h-4 text-yellow-500 mt-0.5 shrink-0"></i><div><span><span class="font-semibold">${maintenance_compliance.total_maintenance_records}</span> maintenance records logged.</span><span class="block text-gray-400 dark:text-gray-500 text-xs">Total historical tasks.</span></div></li>`;
      }
      insightsList.innerHTML = insightsHTML || `<li>No performance data available.</li>`;
      lucide.createIcons();
  }

  async function fetchAndDisplayAlerts() {
      const alertsList = document.getElementById('notificationsList');
      const notificationCountSpan = document.getElementById('notificationCount');
      if (!alertsList || !notificationCountSpan) return;

      alertsList.innerHTML = `<div class="flex items-start space-x-2 p-2.5 bg-gray-100 dark:bg-gray-700/50 rounded-lg"><i data-lucide="loader-2" class="w-5 h-5 text-gray-400 animate-spin mt-0.5 flex-shrink-0"></i><p class="text-xs text-gray-700 dark:text-gray-300">Loading alerts...</p></div>`;
      lucide.createIcons();

      const data = await apiRequest('/dashboard-data/alerts');
      if (!data) {
          alertsList.innerHTML = `<div class="flex items-start space-x-2 text-red-500"><i data-lucide="alert-circle" class="w-4 h-4 mt-0.5 shrink-0"></i><p class="text-xs">Failed to load alerts.</p></div>`;
          notificationCountSpan.textContent = '0';
          lucide.createIcons();
          return;
      }

      notificationCountSpan.textContent = data.total_alerts || '0';
      let alertsHTML = '';
      const createAlertItemHTML = (alert, icon, colorClass) => {
          if (!alert) return '';
          return `<div class="flex items-start space-x-2 p-2.5 bg-gray-100 dark:bg-gray-700/50 rounded-lg"><i data-lucide="${icon}" class="w-5 h-5 ${colorClass} mt-0.5 flex-shrink-0"></i><div><p class="text-xs font-semibold text-gray-800 dark:text-gray-200">${alert.plate_number}</p><p class="text-xs text-gray-600 dark:text-gray-300">${alert.message}</p></div></div>`;
      };
      alertsHTML += createAlertItemHTML(data.critical_panne, 'shield-alert', 'text-red-500');
      alertsHTML += createAlertItemHTML(data.maintenance_alert, 'calendar-clock', 'text-blue-500');
      alertsHTML += createAlertItemHTML(data.trip_alert, 'route', 'text-purple-500');
      if (data.total_alerts === 0) {
          alertsHTML = `<div class="flex items-center justify-center text-center p-4"><div class="text-gray-500 dark:text-gray-400"><i data-lucide="check-circle" class="w-8 h-8 mx-auto mb-2 text-green-500"></i><p class="text-xs">All clear! No new alerts.</p></div></div>`;
      }
      alertsList.innerHTML = alertsHTML;
      lucide.createIcons();
  }
  
  async function initializeDashboardWidgets() {
      await Promise.all([
          fetchAndDisplayPerformanceInsights(),
          fetchAndDisplayAlerts()
      ]);
  }

  // --- MODAL & UI Functions ---
   function closeModal(modalId) { 
       const modal = document.getElementById(modalId); 
       if (modal) modal.classList.add('hidden'); 
       document.body.style.overflow = ''; 
    }
   function closeAddFuelModal() { 
       closeModal('addFuelModal'); 
       fuelLogToEditId = null; 
       const form = document.getElementById('addFuelForm'); 
       if (form) form.reset(); 
       const displayArea = document.getElementById('calculatedCostDisplayArea'); 
       if (displayArea) displayArea.style.display = 'none'; 
    }
   function closeViewFuelModal() { closeModal('viewFuelModal'); }
   function closeGenericConfirmModal() { 
       closeModal('genericConfirmModal'); 
       currentConfirmAction = null; 
       currentActionData = null; 
    }
   function closeInfoStatusModal() { 
       if (infoStatusModalTimeout) { 
           clearTimeout(infoSaxctusModalTimeout); 
           infoStatusModalTimeout = null; 
        } 
        closeModal('infoStatusModal'); 
    }
   function openGenericConfirmModal(title, message, confirmButtonText, confirmButtonIconName, onConfirmCallback, actionData = null) { 
       document.getElementById('genericConfirmModalTitle').textContent = title; 
       document.getElementById('genericConfirmModalMessage').textContent = message; 
       const confirmBtnEl = document.getElementById('genericConfirmModalConfirmBtn'); 
       confirmBtnEl.innerHTML = `<i data-lucide="${confirmButtonIconName}" class="w-4 h-4 mr-2"></i> ${confirmButtonText || 'Confirm'}`; 
       if(confirmButtonIconName === 'trash-2'){ 
           confirmBtnEl.classList.remove('bg-blue-500', 'hover:bg-blue-600'); 
           confirmBtnEl.classList.add('bg-red-500', 'hover:bg-red-600'); 
        } else { 
            confirmBtnEl.classList.remove('bg-red-500', 'hover:bg-red-600'); 
            confirmBtnEl.classList.add('bg-blue-500', 'hover:bg-blue-600'); 
        } 
        lucide.createIcons(); 
        currentConfirmAction = onConfirmCallback; 
        currentActionData = actionData; 
        document.getElementById('genericConfirmModal').classList.remove('hidden'); 
        document.body.style.overflow = 'hidden'; 
    }
   function openInfoStatusModal(title, message, type = 'info', autoCloseDelay = 3000) { 
       const modal = document.getElementById('infoStatusModal'); 
       const modalTitleEl = document.getElementById('infoStatusModalTitle'); 
       const modalMessageEl = document.getElementById('infoStatusModalMessage'); 
       const iconContainer = document.getElementById('infoStatusModalIconContainer'); 
       const okButton = document.getElementById('infoStatusModalOkButton'); 
       modalTitleEl.textContent = title; 
       modalMessageEl.textContent = message; 
       if (infoStatusModalTimeout) clearTimeout(infoStatusModalTimeout); 
       iconContainer.innerHTML = ''; 
       let iconName = 'info'; 
       let iconColor = 'blue'; 
       switch (type.toLowerCase()) { 
           case 'success': iconName = 'check-circle'; iconColor = 'green'; break; 
           case 'error': iconName = 'alert-circle'; iconColor = 'red'; break; 
        } 
        iconContainer.className = `mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-${iconColor}-100 dark:bg-${iconColor}-800 mb-4`; 
        iconContainer.innerHTML = `<i data-lucide="${iconName}" class="w-6 h-6 text-${iconColor}-600 dark:text-${iconColor}-400"></i>`; 
        okButton.className = `w-full rounded-md border border-transparent shadow-sm px-4 py-2 bg-${iconColor}-600 text-base font-medium text-white hover:bg-${iconColor}-700 focus:ring-2 focus:ring-offset-2 focus:ring-${iconColor}-500 dark:focus:ring-offset-gray-800`; 
        lucide.createIcons(); 
        modal.classList.remove('hidden'); 
        document.body.style.overflow = 'hidden'; 
        if (autoCloseDelay && autoCloseDelay > 0) { 
            infoStatusModalTimeout = setTimeout(() => { closeInfoStatusModal(); }, autoCloseDelay); 
        } 
    }


  // --- DOMContentLoaded Event Listener ---
  document.addEventListener('DOMContentLoaded', async () => {
      lucide.createIcons();
      updateUserInfoDisplay();
      
      themeToggleButtonHeader?.addEventListener('click', toggleTheme);
      setInitialThemeIcon();

      mobileMenuButton?.addEventListener('click', openMobileMenu);
      sidebarCloseButton?.addEventListener('click', closeMobileMenu);
      sidebarOverlay?.addEventListener('click', closeMobileMenu);
      
      document.getElementById('global-logout-btn')?.addEventListener('click', (e) => {
          e.preventDefault();
          localStorage.removeItem('accessToken');
          openInfoStatusModal("Logged Out", "Successfully logged out.", "success", 2500);
          updateUserInfoDisplay();
          allFetchedFuelLogsFromServer = [];
          renderFuelLogTable();
          document.getElementById('keyPerformanceInsightsList').innerHTML = `<li class="flex items-start space-x-2 text-gray-500"><i data-lucide="log-in" class="w-4 h-4 mt-0.5 shrink-0"></i><span>Please log in to see insights.</span></li>`;
          document.getElementById('notificationsList').innerHTML = `<div class="flex items-start space-x-2 text-gray-500 p-2.5"><i data-lucide="log-in" class="w-5 h-5 mt-0.5 shrink-0"></i><p class="text-xs">Please log in to see alerts.</p></div>`;
          document.getElementById('notificationCount').textContent = '0';
          lucide.createIcons();
      });

      document.getElementById('addFuelForm')?.addEventListener('submit', handleFuelFormSubmit);
      document.getElementById('fuel_quantity_form')?.addEventListener('input', displayDynamicCost);
      document.getElementById('fuel_price_little_form')?.addEventListener('input', displayDynamicCost);
      document.getElementById('openAddFuelModalButton')?.addEventListener('click', openAddFuelModal);
      document.getElementById('exportExcelButton')?.addEventListener('click', exportFuelLogsExcel);
      document.getElementById('exportPdfButton')?.addEventListener('click', exportFuelLogsPDF);
      document.getElementById('fuelVehicleFilter')?.addEventListener('change', applyFuelFilters);
      document.getElementById('fuelFuelTypeFilter')?.addEventListener('change', applyFuelFilters);
      document.getElementById('fuel-filter-today')?.addEventListener('click', () => applyFuelDateFilter('today'));
      document.getElementById('fuel-filter-last7')?.addEventListener('click', () => applyFuelDateFilter('last7days'));
      document.getElementById('fuel-filter-last30')?.addEventListener('click', () => applyFuelDateFilter('last30days'));
      document.getElementById('fuel-filter-all')?.addEventListener('click', () => applyFuelDateFilter('all'));
      document.getElementById('fuel-filter-custom-btn')?.addEventListener('click', toggleFuelCustomDateRange);
      document.getElementById('applyCustomDateFilterButton')?.addEventListener('click', applyFuelCustomDateFilter);
      
      document.getElementById('addFuelModal').addEventListener('click', e => { if (e.target === e.currentTarget) closeAddFuelModal(); });
      document.getElementById('viewFuelModal').addEventListener('click', e => { if (e.target === e.currentTarget) closeViewFuelModal(); });
      document.getElementById('genericConfirmModal').addEventListener('click', e => { if (e.target === e.currentTarget) closeGenericConfirmModal(); });
      document.getElementById('infoStatusModal').addEventListener('click', e => { if (e.target.id === 'infoStatusModal' || e.target.closest('#infoStatusModalOkButton')) closeInfoStatusModal(); });
      document.getElementById('closeAddFuelModalButtonTop')?.addEventListener('click', closeAddFuelModal);
      document.getElementById('cancelAddFuelModalButton')?.addEventListener('click', closeAddFuelModal);
      document.getElementById('closeViewFuelModalButtonTop')?.addEventListener('click', closeViewFuelModal);
      document.getElementById('closeViewFuelModalButtonBottom')?.addEventListener('click', closeViewFuelModal);
      document.getElementById('closeGenericConfirmModalButtonX')?.addEventListener('click', closeGenericConfirmModal);
      document.getElementById('cancelGenericConfirmModalButton')?.addEventListener('click', closeGenericConfirmModal);
      document.getElementById('genericConfirmModalConfirmBtn').addEventListener('click', async () => { if (typeof currentConfirmAction === 'function') await currentConfirmAction(currentActionData); closeGenericConfirmModal(); });

      await initializeFuelLogSection();
  });

  // --- Fuel Specific Functions ---
  function displayDynamicCost() {
      const quantityEl = document.getElementById('fuel_quantity_form');
      const priceLittleEl = document.getElementById('fuel_price_little_form');
      const displayArea = document.getElementById('calculatedCostDisplayArea');
      const costSpan = document.getElementById('displayCalculatedCost');
      if (!quantityEl || !priceLittleEl || !displayArea || !costSpan) return;
      const quantity = parseFloat(quantityEl.value) || 0;
      const priceLittle = parseFloat(priceLittleEl.value) || 0;
      if (quantity > 0 && priceLittle > 0) {
        const calculated = (quantity * priceLittle).toFixed(2);
        costSpan.textContent = `$${calculated}`;
        displayArea.style.display = 'block';
      } else {
        displayArea.style.display = 'none';
        costSpan.textContent = '';
      }
  }

  async function initializeFuelLogSection() {
    console.log("Initializing fuel log section...");
    await fetchDropdownDataForFuel();
    if (!getAuthToken()) {
        document.getElementById('fuelLogBody').innerHTML = `<tr><td colspan="8" class="text-center py-8 text-red-500">Please log in to view fuel logs.</td></tr>`;
        document.getElementById('fuelLogCount').textContent = '0 records';
        document.getElementById('fuelLogPagination').innerHTML = '';
        document.getElementById('keyPerformanceInsightsList').innerHTML = `<li class="flex items-start space-x-2 text-gray-500"><i data-lucide="log-in" class="w-4 h-4 mt-0.5 shrink-0"></i><span>Please log in to see insights.</span></li>`;
        document.getElementById('notificationsList').innerHTML = `<div class="flex items-start space-x-2 text-gray-500 p-2.5"><i data-lucide="log-in" class="w-5 h-5 mt-0.5 shrink-0"></i><p class="text-xs">Please log in to see alerts.</p></div>`;
        document.getElementById('notificationCount').textContent = '0';
        lucide.createIcons();
    } else {
        await fetchFuelLogs();
        await initializeDashboardWidgets();
    }
    setActiveFuelDateFilterButton('all');
  }

  async function fetchDropdownDataForFuel() {
    const [vehicles, fuelTypes] = await Promise.all([
        apiRequest(`${VEHICLE_API_ENDPOINT}?limit=1000`),
        apiRequest(`${FUEL_TYPE_API_ENDPOINT}?limit=100`)
    ]);

    vehicleDataForDropdown_fuel = Array.isArray(vehicles) ? vehicles : [];
    fuelTypeDataForDropdown_fuel = Array.isArray(fuelTypes) ? fuelTypes : [];

    populateSelectWithOptionsGeneric('fuelVehicleFilter', vehicleDataForDropdown_fuel, 'id', 'plate_number', "All Vehicles");
    populateSelectWithOptionsGeneric('fuelFuelTypeFilter', fuelTypeDataForDropdown_fuel, 'id', 'fuel_type', "All Fuel Types");
    
    populateSelectWithOptionsGeneric('fuel_vehicle_id_form', vehicleDataForDropdown_fuel, 'id', 'plate_number', "Select Vehicle", v => {
        const makeName = v.make_ref?.vehicle_make || ''; 
        const modelName = v.model_ref?.vehicle_model || '';
        return `${v.plate_number} (${v.year || ''} ${makeName} ${modelName})`.replace(/\s{2,}/g, ' ').trim();
    });

    populateSelectWithOptionsGeneric('fuel_fuel_type_id_form', fuelTypeDataForDropdown_fuel, 'id', 'fuel_type', "Select Fuel Type");
  }

  function populateSelectWithOptionsGeneric(selectElementId, optionsArray, valueField, textField, placeholder = "Select Option", displayFormatter = null) {
    const selectElement = document.getElementById(selectElementId);
    if (!selectElement) return;

    const currentValue = selectElement.value;
    selectElement.innerHTML = `<option value="">${placeholder}</option>`;
    if (!Array.isArray(optionsArray) || optionsArray.length === 0) { selectElement.disabled = true; return; }
    selectElement.disabled = false;

    optionsArray.forEach((opt) => {
        if (typeof opt !== 'object' || opt === null) return;
        const option = document.createElement('option');
        option.value = opt[valueField];
        option.textContent = displayFormatter ? displayFormatter(opt) : (opt[textField] || `ID: ${opt[valueField]}`);
        selectElement.appendChild(option);
    });
    if (optionsArray.some(opt => opt && String(opt[valueField]) === String(currentValue))) { selectElement.value = currentValue; }
  }

  async function fetchFuelLogs() {
    let queryParams = `limit=${fuelLogsPerPage}&skip=${(currentFuelLogPage - 1) * fuelLogsPerPage}`;
    const vehicleFilterVal = document.getElementById('fuelVehicleFilter')?.value;
    const fuelTypeFilterVal = document.getElementById('fuelFuelTypeFilter')?.value;
    if (vehicleFilterVal) queryParams += `&vehicle_id=${vehicleFilterVal}`;
    if (fuelTypeFilterVal) queryParams += `&fuel_type_id=${fuelTypeFilterVal}`;

    const data = await apiRequest(`${FUEL_API_ENDPOINT}?${queryParams}`);
    allFetchedFuelLogsFromServer = Array.isArray(data) ? data : [];
    renderFuelLogTable();
  }

  function formatDateTimeForDisplay(dateTimeStr) { 
      if (!dateTimeStr) return 'N/A'; 
      try { 
          return new Date(dateTimeStr).toLocaleString(undefined, { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }); 
        } catch (e) { 
            return dateTimeStr; 
        } 
    }
  
  function renderFuelLogTable() {
    const recordsToDisplay = allFetchedFuelLogsFromServer;
    const fuelLogBody = document.getElementById('fuelLogBody');
    if (!fuelLogBody) return;

    if (recordsToDisplay.length > 0) {
        fuelLogBody.innerHTML = recordsToDisplay.map(log => {
            const vehicle = vehicleDataForDropdown_fuel.find(v => v.id === log.vehicle_id);
            const fuelType = fuelTypeDataForDropdown_fuel.find(ft => ft.id === log.fuel_type_id);
            const vehicleDisplay = vehicle ? vehicle.plate_number : `Vehicle ID ${log.vehicle_id || 'N/A'}`;
            const fuelTypeDisplay = fuelType ? fuelType.fuel_type : `Fuel Type ID ${log.fuel_type_id || 'N/A'}`;
            
            return `<tr class="border-b dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700/50" data-id="${log.id}">
                        <td class="py-3 px-2">${log.id}</td> <td class="px-2">${vehicleDisplay}</td> <td class="px-2">${fuelTypeDisplay}</td>
                        <td class="px-2 text-right">${(log.quantity || 0).toFixed(2)}</td> <td class="px-2 text-right">${(log.price_little || 0).toFixed(3)}</td>
                        <td class="px-2 text-right">${(log.cost || 0).toFixed(2)}</td> <td class="px-2">${formatDateTimeForDisplay(log.created_at)}</td>
                        <td class="px-2 text-center whitespace-nowrap">
                        <button onclick="openViewFuelModal(${log.id})" class="text-green-600 dark:text-green-400 p-1" title="View"><i data-lucide="eye" class="w-4 h-4"></i></button>
                        <button onclick="openEditFuelModal(${log.id})" class="text-blue-600 dark:text-blue-400 p-1 ml-1" title="Edit"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                        <button onclick="openConfirmDeleteFuelLogModal(${log.id})" class="text-red-600 dark:text-red-400 p-1 ml-1" title="Delete"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </td></tr>`;
        }).join('');
    } else {
        let message = "No fuel log records found.";
        if (!getAuthToken()) message = "Please log in to view fuel logs.";
        else if (!document.getElementById('fuelVehicleFilter')?.value && !document.getElementById('fuelFuelTypeFilter')?.value && activeFuelDateFilter === 'all') message = "No fuel logs recorded yet.";
        else message = "No fuel logs match your current filter criteria.";
        fuelLogBody.innerHTML = `<tr><td colspan="8" class="text-center py-8 text-gray-500">${message}</td></tr>`;
    }
    lucide.createIcons();
    document.getElementById('fuelLogCount').textContent = `Showing ${recordsToDisplay.length} records on this page`;
    renderFuelLogPagination(recordsToDisplay.length);
  }

  function renderFuelLogPagination(currentPageRecordCount) { 
      const paginationContainer = document.getElementById('fuelLogPagination'); 
      if (!paginationContainer) return; 
      paginationContainer.innerHTML = ''; 
      const showPagination = currentFuelLogPage > 1 || currentPageRecordCount === fuelLogsPerPage; 
      if (!showPagination) return; 
      const buttonClasses = "px-3 py-1.5 text-sm rounded-md transition-colors duration-150 focus:outline-none focus:ring-2 focus:ring-offset-1 dark:focus:ring-offset-gray-900 focus:ring-blue-500"; 
      const inactiveClasses = "bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700"; 
      const disabledClasses = "bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-400 dark:text-gray-500 cursor-not-allowed"; 
      const prevButton = document.createElement('button'); 
      prevButton.innerHTML = `<i data-lucide="chevron-left" class="w-4 h-4 inline-block mr-1"></i> Prev`; 
      prevButton.className = `${buttonClasses} ${currentFuelLogPage === 1 ? disabledClasses : inactiveClasses}`; 
      if (currentFuelLogPage > 1) prevButton.onclick = () => { currentFuelLogPage--; fetchFuelLogs(); }; 
      else prevButton.disabled = true; 
      paginationContainer.appendChild(prevButton); 
      const pageInfo = document.createElement('span'); 
      pageInfo.className = "px-3 py-1.5 text-sm text-gray-500 dark:text-gray-400"; 
      pageInfo.textContent = `Page ${currentFuelLogPage}`; 
      paginationContainer.appendChild(pageInfo); 
      const nextButton = document.createElement('button'); 
      nextButton.innerHTML = `Next <i data-lucide="chevron-right" class="w-4 h-4 inline-block ml-1"></i>`; 
      const hasMore = currentPageRecordCount === fuelLogsPerPage; 
      nextButton.className = `${buttonClasses} ${!hasMore ? disabledClasses : inactiveClasses}`; 
      if (hasMore) nextButton.onclick = () => { currentFuelLogPage++; fetchFuelLogs(); }; 
      else nextButton.disabled = true; 
      paginationContainer.appendChild(nextButton); 
      lucide.createIcons(); 
    }

  async function openAddFuelModal() { 
      if (!getAuthToken()) { openInfoStatusModal("Authentication Required","Please log in.", "error"); return; } 
      fuelLogToEditId = null; 
      document.getElementById('addFuelForm').reset(); 
      document.getElementById('fuelModalTitle').textContent = "Add New Fuel Log"; 
      document.getElementById('fuelSubmitButton').innerHTML = `<i data-lucide="plus-circle" class="w-4 h-4 mr-2"></i> Add Log`; 
      displayDynamicCost(); 
      lucide.createIcons(); 
      document.getElementById('addFuelModal').classList.remove('hidden'); 
      document.body.style.overflow = 'hidden'; 
    }

  async function openEditFuelModal(id) { 
      if (!getAuthToken()) { openInfoStatusModal("Authentication Required","Please log in.", "error"); return; } 
      const recordToEdit = await apiRequest(`${FUEL_API_ENDPOINT}${id}`); 
      if (!recordToEdit) { openInfoStatusModal("Error","Could not fetch fuel log details.", "error"); return; } 
      fuelLogToEditId = id; 
      document.getElementById('addFuelForm').reset(); 
      document.getElementById('fuelModalTitle').textContent = "Edit Fuel Log"; 
      document.getElementById('fuelSubmitButton').innerHTML = `<i data-lucide="save" class="w-4 h-4 mr-2"></i> Save Changes`; 
      document.getElementById('fuelId_form').value = recordToEdit.id; 
      document.getElementById('fuel_vehicle_id_form').value = recordToEdit.vehicle_id; 
      document.getElementById('fuel_fuel_type_id_form').value = recordToEdit.fuel_type_id; 
      document.getElementById('fuel_quantity_form').value = recordToEdit.quantity; 
      document.getElementById('fuel_price_little_form').value = recordToEdit.price_little; 
      displayDynamicCost(); 
      lucide.createIcons(); 
      document.getElementById('addFuelModal').classList.remove('hidden'); 
      document.body.style.overflow = 'hidden'; 
    }

  async function openViewFuelModal(id) { 
      const record = await apiRequest(`${FUEL_API_ENDPOINT}${id}`); 
      if (!record) { openInfoStatusModal("Error", "Could not fetch fuel log details.", "error"); return; } 
      const vehicle = vehicleDataForDropdown_fuel.find(v => v.id === record.vehicle_id); 
      const fuelType = fuelTypeDataForDropdown_fuel.find(ft => ft.id === record.fuel_type_id); 
      document.getElementById('view-fuel-id').textContent = record.id || 'N/A'; 
      document.getElementById('view-fuel-vehicle').textContent = vehicle ? vehicle.plate_number : `VID ${record.vehicle_id}`; 
      document.getElementById('view-fuel-fuel_type').textContent = fuelType ? fuelType.fuel_type : `FTID ${record.fuel_type_id}`; 
      document.getElementById('view-fuel-quantity').textContent = `${(record.quantity || 0).toFixed(2)} (L/kWh)`; 
      document.getElementById('view-fuel-price_little').textContent = `$${(record.price_little || 0).toFixed(3)}`; 
      document.getElementById('view-fuel-cost').textContent = `$${(record.cost || 0).toFixed(2)}`; 
      document.getElementById('view-fuel-created_at').textContent = formatDateTimeForDisplay(record.created_at); 
      document.getElementById('viewFuelModal').classList.remove('hidden'); 
      document.body.style.overflow = 'hidden'; 
      lucide.createIcons(); 
    }
  
  async function handleFuelFormSubmit(event) { 
      event.preventDefault(); 
      if (!getAuthToken()) { openInfoStatusModal("Authentication Required","Please log in.", "error"); return; } 
      const fuelData = { 
          vehicle_id: parseInt(document.getElementById('fuel_vehicle_id_form').value), 
          fuel_type_id: parseInt(document.getElementById('fuel_fuel_type_id_form').value), 
          quantity: parseFloat(document.getElementById('fuel_quantity_form').value), 
          price_little: parseFloat(document.getElementById('fuel_price_little_form').value), 
        }; 
        if (isNaN(fuelData.vehicle_id) || isNaN(fuelData.fuel_type_id) || isNaN(fuelData.quantity) || isNaN(fuelData.price_little) || fuelData.quantity <= 0 || fuelData.price_little <= 0) { 
            openInfoStatusModal("Validation Error", "Ensure all fields are correctly filled and values are positive.", "error"); 
            return; 
        } 
        const actionType = fuelLogToEditId ? "update" : "add"; 
        openGenericConfirmModal( 
            fuelLogToEditId ? "Confirm Update" : "Confirm Add Fuel Log", 
            `Are you sure you want to ${actionType} this fuel log?`, 
            fuelLogToEditId ? "Update Log" : "Add Log", 
            fuelLogToEditId ? "save" : "plus-circle", 
            async (dataForAction) => { 
                const result = fuelLogToEditId ? 
                    await apiRequest(`${FUEL_API_ENDPOINT}${fuelLogToEditId}`, 'PUT', dataForAction) : 
                    await apiRequest(FUEL_API_ENDPOINT, 'POST', dataForAction); 
                if (result) { 
                    openInfoStatusModal("Success", `Fuel log ${actionType}d successfully!`, "success"); 
                    closeAddFuelModal(); 
                    currentFuelLogPage = (actionType === 'add') ? 1 : currentFuelLogPage; 
                    await fetchFuelLogs(); 
                } 
            }, 
            fuelData 
        ); 
    }

  function openConfirmDeleteFuelLogModal(id) { 
      if (!getAuthToken()) { 
          openInfoStatusModal("Authentication Required","Please log in.", "error"); 
          return; 
        } 
        openGenericConfirmModal( "Confirm Deletion", `Permanently delete fuel log ID: ${id}?`, "Delete", "trash-2", 
        async (logIdToDelete) => { 
            const result = await apiRequest(`${FUEL_API_ENDPOINT}${logIdToDelete}`, 'DELETE'); 
            if (result === true) { 
                openInfoStatusModal("Success", `Fuel log ID: ${logIdToDelete} deleted.`, "success"); 
                if(allFetchedFuelLogsFromServer.length === 1 && currentFuelLogPage > 1) currentFuelLogPage--; 
                await fetchFuelLogs(); 
            } 
        }, id ); 
    }

  function applyFuelFilters() { currentFuelLogPage = 1; fetchFuelLogs(); }
  
  function applyFuelDateFilter(filterType) { 
      activeFuelDateFilter = filterType; 
      customFuelFilterStartDate = null; 
      customFuelFilterEndDate = null; 
      document.getElementById('fuelCustomDateRange').classList.add('hidden'); 
      setActiveFuelDateFilterButton(filterType); 
      currentFuelLogPage = 1; 
      fetchFuelLogs(); 
    }
  
  function setActiveFuelDateFilterButton(filterTypeOrId) { 
      document.querySelectorAll('#fuel-section .date-filter-btn').forEach(btn => btn.classList.remove('active')); 
      const activeBtn = document.getElementById(filterTypeOrId.startsWith('fuel-filter-') ? filterTypeOrId : `fuel-filter-${filterTypeOrId}`); 
      if (activeBtn) activeBtn.classList.add('active'); 
    }

  function toggleFuelCustomDateRange() { 
      const el = document.getElementById('fuelCustomDateRange'); 
      el.classList.toggle('hidden'); 
      if (!el.classList.contains('hidden')) setActiveFuelDateFilterButton('fuel-filter-custom-btn'); 
      else if (activeFuelDateFilter === 'custom') applyFuelDateFilter('all'); 
    }
  
  function applyFuelCustomDateFilter() { 
      const startDate = document.getElementById('fuelCustomStartDate').value; 
      const endDate = document.getElementById('fuelCustomEndDate').value; 
      if (!startDate || !endDate || new Date(startDate) > new Date(endDate)) { 
          openInfoStatusModal("Input Error", "Please select a valid date range.", "error"); 
          return; 
        } 
        activeFuelDateFilter = 'custom'; 
        customFuelFilterStartDate = startDate; 
        customFuelFilterEndDate = endDate; 
        setActiveFuelDateFilterButton('fuel-filter-custom-btn'); 
        currentFuelLogPage = 1; 
        fetchFuelLogs(); 
    }
  
  function getFuelExportData() { return allFetchedFuelLogsFromServer; }

  function exportFuelLogsExcel() { 
      if (!getAuthToken() || getFuelExportData().length === 0) { 
          openInfoStatusModal("Export Error", "No data available to export.", "error"); 
          return;
        } 
        const records = getFuelExportData(); 
        const wsData = records.map(log => { 
            const vehicle = vehicleDataForDropdown_fuel.find(v => v.id === log.vehicle_id); 
            const fuelType = fuelTypeDataForDropdown_fuel.find(ft => ft.id === log.fuel_type_id); 
            return {
                'ID': log.id, 'Vehicle Plate': vehicle?.plate_number || `ID ${log.vehicle_id}`, 
                'Fuel Type': fuelType?.fuel_type || `ID ${log.fuel_type_id}`, 
                'Quantity': (log.quantity || 0).toFixed(2), 
                'Price/Unit ($)': (log.price_little || 0).toFixed(3), 
                'Total Cost ($)': (log.cost || 0).toFixed(2), 
                'Date Recorded': formatDateTimeForDisplay(log.created_at) 
            }; 
        }); 
        const ws = XLSX.utils.json_to_sheet(wsData); 
        const wb = XLSX.utils.book_new(); 
        XLSX.utils.book_append_sheet(wb, ws, "FuelLogs"); 
        XLSX.writeFile(wb, "fuel_logs_export.xlsx"); 
    }

  function exportFuelLogsPDF() { 
      if (!getAuthToken() || getFuelExportData().length === 0) { 
          openInfoStatusModal("Export Error", "No data available to export.", "error"); 
          return;
        } 
        const {jsPDF} = window.jspdf; 
        const doc = new jsPDF(); 
        doc.setFontSize(18); 
        doc.text('Fuel Log Records', 14, 15); 
        const records = getFuelExportData(); 
        const headers = [['ID', 'Vehicle', 'Fuel Type', 'Qty', 'Price/Unit', 'Total', 'Date']]; 
        const data = records.map(log => { 
            const vehicle = vehicleDataForDropdown_fuel.find(v => v.id === log.vehicle_id); 
            const fuelType = fuelTypeDataForDropdown_fuel.find(ft => ft.id === log.fuel_type_id); 
            return [ 
                log.id, 
                vehicle?.plate_number || `ID ${log.vehicle_id}`, 
                fuelType?.fuel_type || `ID ${log.fuel_type_id}`, 
                (log.quantity || 0).toFixed(2), 
                `$${(log.price_little || 0).toFixed(3)}`, 
                `$${(log.cost || 0).toFixed(2)}`, 
                new Date(log.created_at).toLocaleDateString() 
            ]; 
        }); 
        doc.autoTable({ 
            head: headers, 
            body: data, 
            startY: 25, 
            theme:'grid', 
            columnStyles: { 0:{halign:'right'},3:{halign:'right'},4:{halign:'right'},5:{halign:'right'} } 
        }); 
        doc.save('fuel_logs_export.pdf'); 
    }

</script>
<script src="/static/js/global.js"></script> 
</body>
</html>