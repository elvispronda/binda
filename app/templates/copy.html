<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard - Fleet Overview</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script>
    // Ensure tailwind.config is globally available before any script tries to use it
    window.tailwind = {
      config: {
        darkMode: 'class',
        theme: {
          extend: {
            colors: {
              primary: { DEFAULT: '#3b82f6', hover: '#2563eb', dark: '#60a5fa', 'dark-hover': '#3b82f6', light: '#dbeafe' },
              secondary: { DEFAULT: '#10b981', hover: '#059669', dark: '#34d399', 'dark-hover': '#10b981', light: '#d1fae5' },
              warning: { DEFAULT: '#f59e0b', hover: '#d97706', dark: '#fbbf24', 'dark-hover': '#f59e0b', light: '#fef3c7' },
              danger: { DEFAULT: '#ef4444', hover: '#dc2626', dark: '#f87171', 'dark-hover': '#ef4444', light: '#fee2e2' },
              info: { DEFAULT: '#3b82f6', light: '#dbeafe', dark: '#60a5fa' },
              gray: { // Added for chart defaults if needed, tailwind provides these by default but good for explicitness
                50: '#f9fafb', 100: '#f3f4f6', 200: '#e5e7eb', 300: '#d1d5db', 400: '#9ca3af',
                500: '#6b7280', 600: '#4b5563', 700: '#374151', 800: '#1f2937', 900: '#111827'
              }
            }
          }
        }
      }
    };
  </script>
  <style>
    body { font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji"; }
    .kpi-card { transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
    .kpi-card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); }
    .dark .kpi-card:hover { box-shadow: 0 10px 15px -3px rgba(0,0,0,0.3), 0 4px 6px -2px rgba(0,0,0,0.25); }
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
    ::-webkit-scrollbar-thumb { background: #c7c7c7; border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: #a3a3a3; }
    .dark ::-webkit-scrollbar-track { background: #2d3748; }
    .dark ::-webkit-scrollbar-thumb { background: #4a5568; }
    .dark ::-webkit-scrollbar-thumb:hover { background: #718096; }
    .kpi-value { font-size: 1.625rem; line-height: 2.125rem; word-break: break-all; }
     @media (min-width: 1024px) { .kpi-value { font-size: 1.75rem; line-height: 2.25rem; } }
    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border-width: 0; }
  </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-white antialiased">

<!-- Main application wrapper -->
<div class="flex h-screen">

    <!-- Sidebar (Left) - From your provided HTML -->
    <aside id="sidebar" class="fixed inset-y-0 left-0 z-40 w-64 bg-white dark:bg-gray-800/95 backdrop-blur-sm p-4 space-y-6 shadow-lg 
                             transform -translate-x-full transition-transform duration-300 ease-in-out 
                             md:relative md:translate-x-0 md:shadow-lg md:border-r dark:border-gray-700 
                             flex flex-col flex-shrink-0">
      <div class="flex items-center justify-between">
          <div class="text-2xl font-bold flex items-center space-x-2 text-primary dark:text-primary-light">
            <i data-lucide="command" class="w-7 h-7"></i><span>FleetDash</span>
          </div>
          <button id="sidebar-close-button" class="md:hidden p-1 rounded-md text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none">
              <span class="sr-only">Close menu</span> <i data-lucide="x" class="w-5 h-5"></i>
          </button>
      </div>
      <nav class="flex-1 overflow-y-auto">
        <ul class="space-y-2">
            <li class="flex items-center space-x-3 text-blue-600 dark:text-blue-400 font-semibold bg-blue-50 dark:bg-gray-700 p-2 rounded-md transition-colors"> <i data-lucide="layout-dashboard" class="w-5 h-5"></i><a href="/dashboard">Dashboard</a> </li>
            <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors"> <i data-lucide="users" class="w-5 h-5"></i><a href="/users">User</a> </li>
            <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors"> <i data-lucide="user" class="w-5 h-5"></i><a href="/driver">Driver</a> </li>
            <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors"> <i data-lucide="alert-triangle" class="w-5 h-5"></i><a href="/panne">Pannes</a> </li>
            <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors"> <i data-lucide="car" class="w-5 h-5"></i><a href="/vehicle">Vehicles</a> </li>
            <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors"> <i data-lucide="wrench" class="w-5 h-5"></i><a href="/reparation">Reparation</a> </li>
            <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors"> <i data-lucide="droplet" class="w-5 h-5"></i><a href="/fuel">Fuel</a> </li>
            <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors"> <i data-lucide="tool" class="w-5 h-5"></i><a href="/maintenance">Maintenance</a> </li>
            <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors"> <i data-lucide="route" class="w-5 h-5"></i><a href="/trip">Trip</a> </li>
        </ul>
      </nav>
       <div class="pt-4 border-t border-gray-200 dark:border-gray-700/50 mt-auto">
            <a href="#" id="global-logout-btn" class="flex items-center space-x-3 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700/40 p-2.5 rounded-lg transition-colors">
                <i data-lucide="log-out" class="w-5 h-5"></i><span>Logout</span>
            </a>
       </div>
    </aside>
    <div id="sidebar-overlay" class="fixed inset-0 z-30 bg-black bg-opacity-50 hidden md:hidden"></div>
    
    <div class="flex-1 flex flex-col overflow-hidden">
      <header class="bg-white dark:bg-gray-800 shadow p-3 flex justify-between items-center flex-shrink-0 h-16">
          <button id="mobile-menu-button" class="md:hidden text-gray-700 dark:text-gray-300 focus:outline-none p-2"> <i data-lucide="menu" class="w-6 h-6"></i> </button>
          <div class="text-lg font-bold text-primary dark:text-primary-light md:hidden">FleetDash</div>
          <div class="hidden md:block text-xl font-semibold text-gray-700 dark:text-gray-200">Dashboard Overview</div>
          <div class="flex items-center space-x-3">
              <button id="theme-toggle-header" class="text-xl p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300"></button>
              <div class="hidden md:flex items-center space-x-2">
                  <div class="text-sm font-semibold" id="userDisplayNameHeader">User</div>
                  <div class="text-xs text-gray-500 dark:text-gray-400" id="userRoleDisplayHeader">Fleet Manager</div>
              </div>
          </div>
      </header>

      <div class="flex-1 flex overflow-hidden">
        <main class="flex-1 overflow-y-auto p-6 md:p-8 space-y-6 md:space-y-8">
          <header class="flex flex-col sm:flex-row justify-between items-center space-y-3 sm:space-y-0">
              <div></div> 
              <div class="flex items-center space-x-3">
                  <div class="relative">
                       <button id="quickAddBtn" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary-hover dark:bg-primary-dark dark:hover:bg-primary-dark-hover flex items-center gap-2 shadow-sm transition-colors">
                          <i data-lucide="plus-circle" class="w-5 h-5"></i> Quick Add
                      </button>
                      <div id="quickAddDropdown" class="absolute right-0 mt-2 w-48 bg-white dark:bg-gray-700 rounded-md shadow-xl z-10 hidden">
                          <a href="/vehicle" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600">New Vehicle</a>
                          <a href="/fuel" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600">Log Fuel</a>
                          <a href="/panne" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600">Report Panne</a>
                      </div>
                  </div>
                  <input type="date" id="dashboardDateFilter" class="border dark:border-gray-600 rounded-lg px-3 py-2 text-sm text-black dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent appearance-none">
              </div>
          </header>

          <!-- KPI Cards Section - Original Structure -->
          <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6">
              <div class="kpi-card bg-white dark:bg-gray-800 p-5 rounded-xl shadow-lg flex items-start justify-between">
                  <div>
                      <p class="text-sm text-gray-500 dark:text-gray-400">Total Vehicles</p>
                      <p id="kpiTotalVehicles" class="kpi-value font-bold text-gray-800 dark:text-white mt-1">0</p>
                  </div>
                  <div class="p-3 rounded-full bg-primary-light dark:bg-primary/20 text-primary dark:text-primary-light">
                      <i data-lucide="truck" class="w-6 h-6"></i>
                  </div>
              </div>
              <div class="kpi-card bg-white dark:bg-gray-800 p-5 rounded-xl shadow-lg flex items-start justify-between">
                  <div>
                      <p class="text-sm text-gray-500 dark:text-gray-400">Planned Trips</p>
                      <p id="kpiPlannedTrips" class="kpi-value font-bold text-gray-800 dark:text-white mt-1">0</p>
                  </div>
                  <div class="p-3 rounded-full bg-secondary-light dark:bg-secondary/20 text-secondary dark:text-secondary-light">
                      <i data-lucide="route" class="w-6 h-6"></i>
                  </div>
              </div>
              <div class="kpi-card bg-white dark:bg-gray-800 p-5 rounded-xl shadow-lg flex items-start justify-between">
                   <div>
                      <p class="text-sm text-gray-500 dark:text-gray-400">Repairs (This Month)</p>
                      <p id="kpiRepairsMonth" class="kpi-value font-bold text-gray-800 dark:text-white mt-1">0</p>
                  </div>
                  <div class="p-3 rounded-full bg-warning-light dark:bg-warning/20 text-warning dark:text-warning-light">
                      <i data-lucide="wrench" class="w-6 h-6"></i>
                  </div>
              </div>
              <div class="kpi-card bg-white dark:bg-gray-800 p-5 rounded-xl shadow-lg flex items-start justify-between">
                  <div>
                      <p class="text-sm text-gray-500 dark:text-gray-400">Fuel Cost (This Week)</p>
                      <p id="kpiFuelCostWeek" class="kpi-value font-bold text-gray-800 dark:text-white mt-1">$0</p>
                  </div>
                  <div class="p-3 rounded-full bg-danger-light dark:bg-danger/20 text-danger dark:text-danger-light">
                      <i data-lucide="fuel" class="w-6 h-6"></i>
                  </div>
              </div>
          </section>

          <section class="grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6">
              <div class="lg:col-span-2 bg-white dark:bg-gray-800 p-5 rounded-xl shadow-lg">
                  <h3 class="text-lg font-semibold mb-4 text-gray-700 dark:text-gray-200">Monthly Activity Summary</h3>
                  <div class="h-72 md:h-80"><canvas id="monthlyActivityChart"></canvas></div>
              </div>
              <div class="bg-white dark:bg-gray-800 p-5 rounded-xl shadow-lg">
                  <h3 class="text-lg font-semibold mb-4 text-gray-700 dark:text-gray-200">Vehicle Status</h3>
                  <div class="h-72 md:h-80 flex items-center justify-center"><canvas id="vehicleStatusChart"></canvas></div>
              </div>
          </section>
          
          <section class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6">
              <div class="md:col-span-1 bg-white dark:bg-gray-800 p-5 rounded-xl shadow-lg">
                  <h3 class="text-lg font-semibold mb-4 text-gray-700 dark:text-gray-200">System Health</h3>
                  <div class="space-y-3">
                      <div class="flex items-center justify-between"><span class="text-sm text-gray-600 dark:text-gray-300">API Server</span><span class="text-sm font-medium text-green-500 dark:text-green-400 flex items-center"><i data-lucide="check-circle" class="w-4 h-4 mr-1"></i> Operational</span></div>
                      <div class="flex items-center justify-between"><span class="text-sm text-gray-600 dark:text-gray-300">Database</span><span class="text-sm font-medium text-green-500 dark:text-green-400 flex items-center"><i data-lucide="check-circle" class="w-4 h-4 mr-1"></i> Optimal</span></div>
                      <div class="flex items-center justify-between"><span class="text-sm text-gray-600 dark:text-gray-300">GPS Tracking</span><span class="text-sm font-medium text-yellow-500 dark:text-yellow-400 flex items-center"><i data-lucide="alert-circle" class="w-4 h-4 mr-1"></i> Minor Delay</span></div>
                       <div class="flex items-center justify-between"><span class="text-sm text-gray-600 dark:text-gray-300">Notification Service</span><span class="text-sm font-medium text-green-500 dark:text-green-400 flex items-center"><i data-lucide="check-circle" class="w-4 h-4 mr-1"></i> Active</span></div>
                  </div>
              </div>
              <!-- In dashboard.html, main content area -->
              <div class="md:col-span-2 bg-white dark:bg-gray-800 p-5 rounded-xl shadow-lg">
                    <h3 class="text-lg font-semibold mb-4 text-gray-700 dark:text-gray-200">Top Performing Drivers (Last 30 Days)</h3>
                    <ul id="topPerformingDriversList" class="space-y-3">
                        <!-- JavaScript will populate this -->
                        <li class="p-2 text-sm text-gray-500">Loading...</li>
                    </ul>
              </div>
          </section>

          <section class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
              <div class="bg-white dark:bg-gray-800 p-5 rounded-xl shadow-lg">
                  <h3 class="text-lg font-semibold mb-4 text-gray-700 dark:text-gray-200">Recent Pannes</h3>
                  <ul id="recentPannesListDashboard" class="space-y-3 max-h-60 overflow-y-auto">
                       <li class="p-3"><div><p class="font-medium">Loading...</p></div></li>
                  </ul>
              </div>
              <div class="bg-white dark:bg-gray-800 p-5 rounded-xl shadow-lg">
                  <h3 class="text-lg font-semibold mb-4 text-gray-700 dark:text-gray-200">Upcoming Trips</h3> 
                   <ul id="upcomingTripsListDashboard" class="space-y-3 max-h-60 overflow-y-auto">
                       <li class="p-3"><div><p class="font-medium">Loading...</p></div></li>
                  </ul>
              </div>
          </section>
        </main>
<aside class="w-1/5 bg-white dark:bg-gray-800/95 backdrop-blur-sm p-4 space-y-6 shadow-lg hidden lg:block flex-shrink-0 border-l dark:border-gray-700 overflow-y-auto">
    <div class="flex justify-end items-center">
        <div class="text-right">
            <div class="text-sm font-semibold" id="userDisplayNameRightSidebar">User</div>
            <div class="text-xs text-gray-500 dark:text-gray-400" id="userRoleDisplayRightSidebar">Role</div>
        </div>
        <img id="rightSidebarAdminAvatar" src="https://i.pravatar.cc/40?u=admin_stats_page" alt="Admin" class="w-10 h-10 rounded-full ml-2 object-cover">
    </div>
    <hr class="dark:border-gray-700/50">
            <div>
                <h4 class="font-semibold mb-3">Key Performance Insights</h4>
                <ul class="text-xs space-y-2.5 text-gray-600 dark:text-gray-300">
                    <li class="flex items-start space-x-2">
                        <i id="fuelEfficiencyIcon" data-lucide="help-circle" class="w-4 h-4 text-gray-500 mt-0.5 shrink-0"></i>
                        <span>Fuel Efficiency: <span class="font-medium" id="fuelEfficiencyStatText">Calculating...</span></span>
                    </li>
                    <li class="flex items-start space-x-2"><i data-lucide="trending-down" class="w-4 h-4 text-red-500 mt-0.5 shrink-0"></i><span>Idle Time: <span class="font-medium">Up 7%</span> (Mock)</span></li>
                    <li class="flex items-start space-x-2">
                        <i id="maintenanceTotalIcon" data-lucide="tools" class="w-4 h-4 text-blue-500 mt-0.5 shrink-0"></i> <!-- Corrected Icon -->
                        <span>Total Maintenance: <span class="font-medium" id="maintenanceTotalStatText">Calculating...</span></span>
                    </li>
                </ul>
            </div>
            <hr class="dark:border-gray-700/50">
            <div>
                <div class="flex justify-between items-center mb-3">
                    <h4 class="font-semibold">Alerts & Notifications</h4>
                    <a href="#" class="text-xs text-primary hover:underline">View All (<span id="notificationCount">0</span>)</a>
                </div>
                <div class="space-y-3 max-h-40 overflow-y-auto pr-1">
                    <div id="alertCriticalPanne" class="hidden items-start space-x-2 p-2.5 bg-danger-light dark:bg-danger/20 rounded-lg">
                        <i data-lucide="alert-octagon" class="w-5 h-5 text-danger dark:text-danger-light mt-0.5 shrink-0"></i>
                        <p class="text-xs">Critical: Vehicle <span class="font-medium" id="criticalPannePlate">N/A</span>: <span id="criticalPanneType">N/A</span>.</p>
                    </div>
                    <div id="alertMaintenance" class="hidden items-start space-x-2 p-2.5 bg-warning-light dark:bg-warning/20 rounded-lg">
                        <i data-lucide="clock" class="w-5 h-5 text-warning dark:text-warning-light mt-0.5 shrink-0"></i>
                        <p class="text-xs">Maint. for <span class="font-medium" id="maintAlertPlate">N/A</span>: <span id="maintAlertStatusText">N/A</span>.</p>
                    </div>
                    <div id="alertTrip" class="hidden items-start space-x-2 p-2.5 bg-info-light dark:bg-info/20 rounded-lg">
                        <i data-lucide="check-circle-2" class="w-5 h-5 text-info dark:text-info-light mt-0.5 shrink-0"></i>
                        <p class="text-xs">Trip update for <span class="font-medium" id="tripAlertPlate">N/A</span>: <span id="tripAlertStatusText">N/A</span>.</p>
                    </div>
                    <div id="noAlerts" class="text-xs text-gray-500 dark:text-gray-400 p-2.5">No new alerts.</div>
                </div>
            </div>
        </aside>
      </div>
    </div>
</div>

<!-- Info/Status Modal -->
<div id="infoStatusModal" class="modal fixed inset-0 z-[100] hidden flex items-center justify-center p-4 bg-black bg-opacity-50">
  <div class="modal-content bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md">
    <div class="p-6 text-center">
      <div id="infoStatusModalIconContainer" class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 dark:bg-green-800/30 mb-4"></div>
      <h3 id="infoStatusModalTitle" class="text-lg font-medium text-gray-900 dark:text-white mb-2">Status</h3>
      <div class="mt-2"><p id="infoStatusModalMessage" class="text-sm text-gray-500 dark:text-gray-400">Message.</p></div>
      <div class="mt-5 sm:mt-6"><button type="button" id="infoStatusModalOkButton" class="btn-primary w-full">OK</button></div>
    </div>
  </div>
</div>




<script>
  const DASH_API_PAGE_BASE_URL = 'http://localhost:8000'; 
  const DASH_API_DATA_NAMESPACE = '/dashboard-data'; 
  const LOGIN_PAGE_URL = '/login';

  // --- UI Helper Functions (Sidebar, Theme, Modals - Assume these are fully defined based on previous versions) ---
  const dashboardSidebar = document.getElementById('sidebar');
  const dashboardMobileMenuButton = document.getElementById('mobile-menu-button');
  const dashboardSidebarCloseButton = document.getElementById('sidebar-close-button');
  const dashboardSidebarOverlay = document.getElementById('sidebar-overlay');

  function openDashboardMobileMenu() { if (dashboardSidebar && dashboardSidebarOverlay) { dashboardSidebar.classList.remove('-translate-x-full'); dashboardSidebar.classList.add('translate-x-0'); dashboardSidebarOverlay.classList.remove('hidden'); document.body.classList.add('overflow-hidden', 'md:overflow-auto'); } }
  function closeDashboardMobileMenu() { if (dashboardSidebar && dashboardSidebarOverlay) { dashboardSidebar.classList.add('-translate-x-full'); dashboardSidebar.classList.remove('translate-x-0'); dashboardSidebarOverlay.classList.add('hidden'); document.body.classList.remove('overflow-hidden'); } }
  
  const dashboardThemeToggleButton = document.getElementById('theme-toggle-header');
  function setDashboardInitialThemeIcon() { 
    if (dashboardThemeToggleButton) { 
      dashboardThemeToggleButton.innerHTML = document.documentElement.classList.contains('dark') ? '<i data-lucide="sun" class="w-5 h-5"></i>' : '<i data-lucide="moon" class="w-5 h-5"></i>'; 
      if (typeof lucide !== 'undefined') lucide.createIcons({ nodes: [dashboardThemeToggleButton]});
    }
  }

  let infoStatusModalTimeoutDashboard;
  function openInfoStatusModalOnDashboard(title, message, type = 'info', autoCloseDelay = 3000) {
    const modal = document.getElementById('infoStatusModal');
    if(!modal) { console.error("InfoStatusModal not found!"); alert(`${type}: ${title} - ${message}`); return; }
    const titleEl = modal.querySelector('#infoStatusModalTitle');
    const messageEl = modal.querySelector('#infoStatusModalMessage');
    const iconContainer = modal.querySelector('#infoStatusModalIconContainer');
    const okButton = modal.querySelector('#infoStatusModalOkButton');

    if(titleEl) titleEl.textContent = title;
    if(messageEl) messageEl.textContent = message;
    if (infoStatusModalTimeoutDashboard) clearTimeout(infoStatusModalTimeoutDashboard);

    let iconName = 'info', iconColorClass = 'text-blue-600 dark:text-blue-400', bgColorClass = 'bg-blue-100 dark:bg-blue-800/30', btnClass = 'bg-blue-600 hover:bg-blue-700 focus:ring-blue-500';
    if (type === 'success') { iconName = 'check-circle-2'; iconColorClass = 'text-green-600 dark:text-green-400'; bgColorClass = 'bg-green-100 dark:bg-green-800/30'; btnClass = 'bg-green-600 hover:bg-green-700 focus:ring-green-500'; }
    else if (type === 'error') { iconName = 'alert-triangle'; iconColorClass = 'text-red-600 dark:text-red-400'; bgColorClass = 'bg-red-100 dark:bg-red-800/30'; btnClass = 'bg-red-600 hover:bg-red-700 focus:ring-red-500'; }
    else if (type === 'warning') { iconName = 'alert-octagon'; iconColorClass = 'text-yellow-500 dark:text-yellow-400'; bgColorClass = 'bg-yellow-100 dark:bg-yellow-800/30'; btnClass = 'bg-yellow-500 hover:bg-yellow-600 focus:ring-yellow-400';}
    
    if(iconContainer) {
        iconContainer.className = `mx-auto flex items-center justify-center h-12 w-12 rounded-full ${bgColorClass} mb-4`;
        iconContainer.innerHTML = `<i data-lucide="${iconName}" class="h-6 w-6 ${iconColorClass}"></i>`;
    }
    if(okButton) okButton.className = `inline-flex justify-center w-full rounded-md border border-transparent shadow-sm px-4 py-2 text-base font-medium text-white ${btnClass} focus:outline-none focus:ring-2 focus:ring-offset-2 dark:focus:ring-offset-gray-800 sm:text-sm`;
    
    if (typeof lucide !== 'undefined') lucide.createIcons({ nodes: [iconContainer] });
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    if (autoCloseDelay > 0 && type !== 'error') { 
        infoStatusModalTimeoutDashboard = setTimeout(() => closeInfoStatusModalOnDashboard(), autoCloseDelay);
    }
  }
  function closeInfoStatusModalOnDashboard() { 
    if(infoStatusModalTimeoutDashboard) clearTimeout(infoStatusModalTimeoutDashboard); 
    document.getElementById('infoStatusModal')?.classList.add('hidden'); 
    document.body.style.overflow = '';
  }

  // --- Authentication & API Helper ---
  function getDashboardAuthToken() { return localStorage.getItem('accessToken'); } 
  function parseDashboardJwt(token) { try { return JSON.parse(atob(token.split('.')[1])); } catch (e) { console.error("JWT Parse Error:", e); return null; }}

  function updateDashboardUserInfo() {
    const token = getDashboardAuthToken(); 
    const decodedToken = token ? parseDashboardJwt(token) : null; 

    const username = decodedToken?.sub || 'Guest';
    const roleFromToken = decodedToken?.role || decodedToken?.status || 'User'; 
    const role = roleFromToken.charAt(0).toUpperCase() + roleFromToken.slice(1);

    const userDisplayNameHeaderEl = document.getElementById('userDisplayNameHeader');
    const userRoleDisplayHeaderEl = document.getElementById('userRoleDisplayHeader');
    if (userDisplayNameHeaderEl) userDisplayNameHeaderEl.textContent = username;
    if (userRoleDisplayHeaderEl) userRoleDisplayHeaderEl.textContent = role;

    const userDisplayNameRightSidebarEl = document.getElementById('userDisplayNameRightSidebar');
    const userRoleDisplayRightSidebarEl = document.getElementById('userRoleDisplayRightSidebar');
    if (userDisplayNameRightSidebarEl) userDisplayNameRightSidebarEl.textContent = username;
    if (userRoleDisplayRightSidebarEl) userRoleDisplayRightSidebarEl.textContent = role;

    const adminAvatarImg = document.getElementById('rightSidebarAdminAvatar'); 
    if (adminAvatarImg) {
        const avatarSeed = username !== 'Guest' ? username.replace(/\s+/g, '').toLowerCase() : 'default_admin_seed';
        adminAvatarImg.src = `https://i.pravatar.cc/40?u=${encodeURIComponent(avatarSeed)}`;
    } else {
        console.warn("Could not find element with ID 'rightSidebarAdminAvatar' to update avatar.");
    }
  }

  async function apiRequestDashboard(endpointSubPath, method = 'GET', body = null) {
    const token = getDashboardAuthToken();
    const headers = { 'Content-Type': 'application/json', 'Accept': 'application/json' };
    const fullApiPath = `${DASH_API_PAGE_BASE_URL}${DASH_API_DATA_NAMESPACE}${endpointSubPath}`;
    
    if (token) {
      headers['Authorization'] = `Bearer ${token}`;
    } else {
      console.warn(`Auth token needed for ${method} ${fullApiPath} but not found.`);
      openInfoStatusModalOnDashboard("Authentication Required", "Please log in to view data.", "error", 0);
      return Promise.resolve(null); 
    }
    
    const config = { method, headers };
    if (body) config.body = JSON.stringify(body);
    
    let responseBodyText = "";
    try {
      const response = await fetch(fullApiPath, config);
      responseBodyText = await response.text();
      if (response.status === 401) {
        openInfoStatusModalOnDashboard("Authentication Error", "Session expired or unauthorized. Please log in again.", "error", 3000);
        localStorage.removeItem('accessToken'); // Clear invalid token
        setTimeout(() => { window.location.href = LOGIN_PAGE_URL; }, 2500);
        return null;
      }
      if (!response.ok) {
        let errorDetail = `Server error ${response.status}.`;
        try { const errData = JSON.parse(responseBodyText); errorDetail = errData.detail || (Array.isArray(errData) && errData.length > 0 && errData[0].msg ? errData.map(e => e.msg).join('; ') : JSON.stringify(errData)); } 
        catch (e) { errorDetail = responseBodyText.substring(0,200) + (responseBodyText.length > 200 ? "..." : "");}
        console.error(`API Error for ${method} ${fullApiPath}: ${response.status}. Detail:`, errorDetail);
        openInfoStatusModalOnDashboard(`API Error: ${response.status}`, errorDetail, "error", 0);
        return null;
      }
      if (response.status === 204 || !responseBodyText) return []; 
      return JSON.parse(responseBodyText);
    } catch (error) {
      console.error(`Network/Catch Error for ${method} ${fullApiPath}: ${error.message}. Raw Response:`, responseBodyText);
      openInfoStatusModalOnDashboard("Request Error", error.message || "A network error occurred.", "error", 0);
      return null;
    }
  }
  
  // --- Dashboard Specific Data Loading & Rendering ---
  async function loadDashboardData() {
    const kpiData = await apiRequestDashboard('/kpis'); 
    if (kpiData) {
        document.getElementById('kpiTotalVehicles').textContent = kpiData.total_vehicles ?? '0';
        document.getElementById('kpiPlannedTrips').textContent = kpiData.planned_trips ?? '0';
        document.getElementById('kpiRepairsMonth').textContent = kpiData.repairs_this_month ?? '0';
        document.getElementById('kpiFuelCostWeek').textContent = `$${(kpiData.fuel_cost_this_week ?? 0).toFixed(2)}`;
    }

    const insightsData = await apiRequestDashboard('/performance-insights');
    if (insightsData && insightsData.fuel_efficiency && insightsData.maintenance_compliance) {
        const fe = insightsData.fuel_efficiency;
        let feText = `${(fe.current_month_volume || 0).toFixed(1)}L (Cur) vs ${(fe.last_month_volume || 0).toFixed(1)}L (Last). `;
        if (fe.percentage_change !== null && fe.percentage_change !== undefined) { feText += `Eff.Chg: ${fe.percentage_change}%`; }
        else { feText += "No comparison data." }
        document.getElementById('fuelEfficiencyStatText').textContent = feText;
        const feIconEl = document.getElementById('fuelEfficiencyIcon');
        if (fe.trend === "up") { feIconEl.setAttribute('data-lucide', 'trending-up'); feIconEl.className = 'w-4 h-4 text-green-500 mt-0.5 shrink-0';}
        else if (fe.trend === "down") { feIconEl.setAttribute('data-lucide', 'trending-down'); feIconEl.className = 'w-4 h-4 text-red-500 mt-0.5 shrink-0'; }
        else { feIconEl.setAttribute('data-lucide', 'minus'); feIconEl.className = 'w-4 h-4 text-gray-500 mt-0.5 shrink-0'; }

        document.getElementById('maintenanceTotalStatText').textContent = `${insightsData.maintenance_compliance.total_maintenance_records ?? 0} records`;
        document.getElementById('maintenanceTotalIcon').setAttribute('data-lucide', 'tools');
    }

    const alertsData = await apiRequestDashboard('/alerts');
    let activeAlertsCount = 0;
    const noAlertsEl = document.getElementById('noAlerts');
    const alertElements = { panne: document.getElementById('alertCriticalPanne'), maintenance: document.getElementById('alertMaintenance'), trip: document.getElementById('alertTrip') };
    Object.values(alertElements).forEach(el => el?.classList.add('hidden'));
    if(noAlertsEl) noAlertsEl.classList.remove('hidden');

    if (alertsData) {
        if (alertsData.critical_panne) {
            document.getElementById('criticalPannePlate').textContent = alertsData.critical_panne.plate_number;
            document.getElementById('criticalPanneType').textContent = alertsData.critical_panne.message;
            if(alertElements.panne) alertElements.panne.classList.remove('hidden'); activeAlertsCount++;
        }
        if (alertsData.maintenance_alert) {
            document.getElementById('maintAlertPlate').textContent = alertsData.maintenance_alert.plate_number;
            let maintMsg = alertsData.maintenance_alert.message;
            if(alertsData.maintenance_alert.status) maintMsg += ` (${alertsData.maintenance_alert.status})`;
            document.getElementById('maintAlertStatusText').textContent = maintMsg;
            if(alertElements.maintenance) alertElements.maintenance.classList.remove('hidden'); activeAlertsCount++;
        }
        if (alertsData.trip_alert) {
            document.getElementById('tripAlertPlate').textContent = alertsData.trip_alert.plate_number;
            let tripMsg = alertsData.trip_alert.message;
            if(alertsData.trip_alert.status) tripMsg += ` (${alertsData.trip_alert.status})`;
            document.getElementById('tripAlertStatusText').textContent = tripMsg;
            if(alertElements.trip) alertElements.trip.classList.remove('hidden'); activeAlertsCount++;
        }
    }
    if (activeAlertsCount > 0 && noAlertsEl) noAlertsEl.classList.add('hidden');
    document.getElementById('notificationCount').textContent = activeAlertsCount;
    
    if (typeof lucide !== 'undefined') lucide.createIcons();
  }
  
  async function loadRecentActivityListsForDashboard() {
    const pannesListEl = document.getElementById('recentPannesListDashboard');
    const upcomingTripsListEl = document.getElementById('upcomingTripsListDashboard');

    if (pannesListEl) {
        const recentPannes = await apiRequestDashboard('/recent-pannes'); 
        if (recentPannes && Array.isArray(recentPannes)) {
            pannesListEl.innerHTML = recentPannes.length > 0 ? recentPannes.map(p => 
                `<li class="flex justify-between items-center p-3 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-md"><div><p class="font-medium">${p.vehicle?.plate_number || 'N/A'}: ${p.category_panne?.panne_name || p.description || 'Issue'}</p><p class="text-xs text-gray-500 dark:text-gray-400">${new Date(p.panne_date).toLocaleDateString()} - ${p.status}</p></div><a href="/panne#${p.id}" class="text-sm text-primary dark:text-primary-light hover:underline">View</a></li>`
            ).join('') : '<li class="p-3 text-sm text-gray-500">No recent pannes.</li>';
        } else { pannesListEl.innerHTML = '<li class="p-3 text-sm text-red-500">Error loading pannes.</li>';}
    }

    if (upcomingTripsListEl) {
        const upcomingTrips = await apiRequestDashboard('/upcoming-trips'); 
        if (upcomingTrips && Array.isArray(upcomingTrips)) {
            upcomingTripsListEl.innerHTML = upcomingTrips.length > 0 ? upcomingTrips.map(trip => {
                const vehiclePlate = trip.vehicle && trip.vehicle.plate_number ? trip.vehicle.plate_number : `Veh.ID ${trip.vehicle_id || 'Unknown'}`;
                const tripPurpose = trip.purpose || 'General Trip';
                const startTime = trip.start_time ? new Date(trip.start_time).toLocaleString() : 'N/A';
                return `<li class="flex justify-between items-center p-3 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-md"><div><p class="font-medium">${vehiclePlate}: ${tripPurpose}</p><p class="text-xs text-gray-500 dark:text-gray-400">Starts: ${startTime}</p></div><a href="/trip#${trip.id}" class="text-sm text-primary dark:text-primary-light hover:underline">Details</a></li>`;
            }).join('') : '<li class="p-3 text-sm text-gray-500">No upcoming trips.</li>';
        } else { upcomingTripsListEl.innerHTML = '<li class="p-3 text-sm text-red-500">Error loading upcoming trips.</li>'; }
    }
    if (typeof lucide !== 'undefined') lucide.createIcons();
  }

  async function loadTopPerformingDrivers() {
    const topDriversListEl = document.getElementById('topPerformingDriversList'); 
    if (!topDriversListEl) {
        console.warn("Element with ID 'topPerformingDriversList' not found for dashboard.");
        return;
    }
    topDriversListEl.innerHTML = '<li class="p-2 text-sm text-gray-500">Loading top drivers...</li>';
    const topDrivers = await apiRequestDashboard('/top-performing-drivers?limit=3'); 
    if (topDrivers && Array.isArray(topDrivers) && topDrivers.length > 0) {
        topDriversListEl.innerHTML = topDrivers.map((driver, index) => `
            <li class="flex items-center justify-between p-2 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-md">
                <div class="flex items-center space-x-3">
                    <img src="https://i.pravatar.cc/40?u=driver${driver.driver_id || index}" alt="Driver ${driver.first_name}" class="w-8 h-8 rounded-full object-cover">
                    <span class="font-medium text-sm text-gray-700 dark:text-gray-200">${driver.first_name} ${driver.last_name}</span>
                </div>
                <span class="text-sm text-green-500 dark:text-green-400">${driver.performance_metric}</span>
            </li>
        `).join('');
    } else if (topDrivers && topDrivers.length === 0) {
        topDriversListEl.innerHTML = '<li class="p-2 text-sm text-gray-500">No driver performance data available.</li>';
    } else {
        topDriversListEl.innerHTML = '<li class="p-2 text-sm text-red-500">Could not load top drivers.</li>';
    }
    if (typeof lucide !== 'undefined') lucide.createIcons();
  }


  // --- Chart Initialization ---
  let monthlyActivityChartInstance = null;
  let vehicleStatusChartInstance = null;
  
  // Helper to get Tailwind colors or fallbacks more robustly
  const getChartColorTailwind = (colorName, variant = 'DEFAULT', fallbackColor) => {
    let color = fallbackColor;
    try {
        if (window.tailwind && window.tailwind.config && window.tailwind.config.theme) {
            let twColorConfig = window.tailwind.config.theme.colors || {}; // Standard Tailwind colors
            if (window.tailwind.config.theme.extend && window.tailwind.config.theme.extend.colors) {
                 // Merge extended colors, extended take precedence
                twColorConfig = { ...twColorConfig, ...window.tailwind.config.theme.extend.colors };
            }

            if (twColorConfig[colorName]) {
                if (typeof twColorConfig[colorName] === 'object' && twColorConfig[colorName][variant]) {
                    color = twColorConfig[colorName][variant];
                } else if (typeof twColorConfig[colorName] === 'string' && variant === 'DEFAULT') {
                    color = twColorConfig[colorName];
                }
            }
        }
    } catch (e) {
        console.warn("Error accessing Tailwind config for chart colors:", e);
    }
    return color;
  };
  
  async function fetchAndInitializeCharts(isThemeChange = false) {
    const monthlyActivityData = await apiRequestDashboard('/charts/monthly-activity?months_to_display=12');
    const vehicleStatusDataFromApi = await apiRequestDashboard('/charts/vehicle-status');
    
    const finalMonthlyData = monthlyActivityData || { labels: [], trips: [], maintenances: [], pannes: [] };
    const finalVehicleStatusData = vehicleStatusDataFromApi && vehicleStatusDataFromApi.labels && vehicleStatusDataFromApi.counts
        ? { labels: vehicleStatusDataFromApi.labels, data: vehicleStatusDataFromApi.counts } 
        : { labels: [], data: [] }; 
    
    initializeDashboardCharts(isThemeChange, finalMonthlyData, finalVehicleStatusData);
  }

  function initializeDashboardCharts(isThemeChange = false, monthlyData, statusData) { 
    const isDark = document.documentElement.classList.contains('dark');

    const gridColor = isDark ? 'rgba(255, 255, 255, 0.15)' : 'rgba(0, 0, 0, 0.08)';
    const tickColor = getChartColorTailwind('gray', isDark ? '400' : '600', isDark ? '#9ca3af' : '#4b5563');
    const legendLabelColor = getChartColorTailwind('gray', isDark ? '300' : '700', isDark ? '#d1d5db' : '#374151');
    const tooltipTitleColor = getChartColorTailwind('gray', isDark ? '100' : '900', isDark ? '#f3f4f6' : '#111827');
    const tooltipBodyColor = getChartColorTailwind('gray', isDark ? '200' : '700', isDark ? '#e5e7eb' : '#374151');
    const tooltipBgColor = isDark ? 'rgba(55, 65, 81, 0.9)' : 'rgba(255, 255, 255, 0.95)'; // gray-700 vs white
    const tooltipBorderColor = isDark ? getChartColorTailwind('gray', '600', '#4b5563') : getChartColorTailwind('gray', '300', '#d1d5db');

    Chart.defaults.font.family = '"Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji"';
    Chart.defaults.color = tickColor;

    // Monthly Activity Chart
    const monthlyCtx = document.getElementById('monthlyActivityChart')?.getContext('2d');
    if (monthlyCtx) {
        if (monthlyActivityChartInstance) {
            monthlyActivityChartInstance.destroy();
        }
        monthlyActivityChartInstance = new Chart(monthlyCtx, {
            type: 'bar',
            data: {
                labels: monthlyData.labels,
                datasets: [
                    {
                        label: 'Trips',
                        data: monthlyData.trips,
                        backgroundColor: getChartColorTailwind('primary', isDark ? 'dark' : 'DEFAULT', '#3b82f6'),
                        borderColor: getChartColorTailwind('primary', isDark ? 'dark' : 'DEFAULT', '#3b82f6'),
                        borderWidth: 1,
                        borderRadius: 3,
                        barPercentage: 0.6,
                        categoryPercentage: 0.7
                    },
                    {
                        label: 'Maintenances',
                        data: monthlyData.maintenances,
                        backgroundColor: getChartColorTailwind('warning', isDark ? 'dark' : 'DEFAULT', '#f59e0b'),
                        borderColor: getChartColorTailwind('warning', isDark ? 'dark' : 'DEFAULT', '#f59e0b'),
                        borderWidth: 1,
                        borderRadius: 3,
                        barPercentage: 0.6,
                        categoryPercentage: 0.7
                    },
                    {
                        label: 'Pannes',
                        data: monthlyData.pannes,
                        backgroundColor: getChartColorTailwind('danger', isDark ? 'dark' : 'DEFAULT', '#ef4444'),
                        borderColor: getChartColorTailwind('danger', isDark ? 'dark' : 'DEFAULT', '#ef4444'),
                        borderWidth: 1,
                        borderRadius: 3,
                        barPercentage: 0.6,
                        categoryPercentage: 0.7
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    x: {
                        stacked: false, 
                        grid: { display: false },
                        ticks: { color: tickColor, font: { size: 11 } }
                    },
                    y: {
                        stacked: false,
                        beginAtZero: true,
                        grid: { color: gridColor, borderColor: gridColor, drawBorder: false },
                        ticks: { color: tickColor, font: { size: 11 }, padding: 8, 
                            callback: function(value) { if (Number.isInteger(value)) { return value; } }
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top', align: 'end',
                        labels: { color: legendLabelColor, usePointStyle: true, boxWidth: 8, font: { size: 12 }, padding: 15 }
                    },
                    tooltip: {
                        backgroundColor: tooltipBgColor, titleColor: tooltipTitleColor, titleFont: { weight: '600', size: 13 },
                        bodyColor: tooltipBodyColor, bodyFont: { size: 12 }, borderColor: tooltipBorderColor,
                        borderWidth: 1, cornerRadius: 4, padding: 10, displayColors: true, boxPadding: 4
                    }
                }
            }
        });
    } else { console.warn("Monthly activity chart canvas not found"); }

    // Vehicle Status Chart
    const statusCtx = document.getElementById('vehicleStatusChart')?.getContext('2d');
    if (statusCtx) {
        if (vehicleStatusChartInstance) {
            vehicleStatusChartInstance.destroy();
        }
        const statusColors = [
            getChartColorTailwind('primary', isDark ? 'dark' : 'DEFAULT', '#3b82f6'),    
            getChartColorTailwind('secondary', isDark ? 'dark' : 'DEFAULT', '#10b981'), 
            getChartColorTailwind('warning', isDark ? 'dark' : 'DEFAULT', '#f59e0b'),   
            getChartColorTailwind('danger', isDark ? 'dark' : 'DEFAULT', '#ef4444'),     
            getChartColorTailwind('gray', isDark ? '500' : '400', '#6b7280'), 
            getChartColorTailwind('info', isDark ? 'dark' : 'DEFAULT', '#3b82f6') 
        ];
        vehicleStatusChartInstance = new Chart(statusCtx, {
            type: 'doughnut',
            data: {
                labels: statusData.labels,
                datasets: [{
                    label: 'Vehicle Status',
                    data: statusData.data,
                    backgroundColor: statusData.labels.map((_, i) => statusColors[i % statusColors.length]),
                    borderColor: isDark ? getChartColorTailwind('gray','800', '#1f2937') : '#ffffff',
                    borderWidth: 2,
                    hoverOffset: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '65%',
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { color: legendLabelColor, usePointStyle: true, boxWidth: 8, font: { size: 12 }, padding: 15 }
                    },
                    tooltip: {
                        backgroundColor: tooltipBgColor, titleColor: tooltipTitleColor, titleFont: { weight: '600', size: 13 },
                        bodyColor: tooltipBodyColor, bodyFont: { size: 12 }, borderColor: tooltipBorderColor,
                        borderWidth: 1, cornerRadius: 4, padding: 10, displayColors: true,
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) { label += ': '; }
                                if (context.parsed !== null) { label += context.parsed; }
                                return label;
                            }
                        }
                    }
                }
            }
        });
    } else { console.warn("Vehicle status chart canvas not found"); }
  }

  // --- DOMContentLoaded for dashboard.html ---
  document.addEventListener('DOMContentLoaded', async () => {
      if (typeof lucide !== 'undefined') lucide.createIcons();
      updateDashboardUserInfo(); 
      setDashboardInitialThemeIcon();

      if (dashboardMobileMenuButton) dashboardMobileMenuButton.addEventListener('click', openDashboardMobileMenu);
      if (dashboardSidebarCloseButton) dashboardSidebarCloseButton.addEventListener('click', closeDashboardMobileMenu);
      if (dashboardSidebarOverlay) dashboardSidebarOverlay.addEventListener('click', closeDashboardMobileMenu);
      if (dashboardThemeToggleButton) {
          dashboardThemeToggleButton.addEventListener('click', async () => { 
              document.documentElement.classList.toggle('dark'); 
              localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
              setDashboardInitialThemeIcon(); 
              await fetchAndInitializeCharts(true); 
          });
      }
       // Apply stored theme on load
      if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
          document.documentElement.classList.add('dark');
      } else {
          document.documentElement.classList.remove('dark');
      }
      setDashboardInitialThemeIcon(); // Set icon after applying theme

      document.querySelectorAll('#sidebar nav a').forEach(link => { 
          link.addEventListener('click', (e) => { if (window.innerWidth < 768 && link.getAttribute('href') && !link.getAttribute('href').startsWith('#')) closeDashboardMobileMenu(); }); 
      });
      
      const quickAddBtn = document.getElementById('quickAddBtn');
      const quickAddDropdown = document.getElementById('quickAddDropdown');
      if(quickAddBtn && quickAddDropdown) { 
        quickAddBtn.addEventListener('click', () => quickAddDropdown.classList.toggle('hidden'));
        document.addEventListener('click', (event) => {
            if (!quickAddBtn.contains(event.target) && !quickAddDropdown.contains(event.target)) {
                quickAddDropdown.classList.add('hidden');
            }
        });
      }
      const dashboardDateFilter = document.getElementById('dashboardDateFilter');
      if (dashboardDateFilter) { 
          dashboardDateFilter.addEventListener('change', async (e) => {
              console.log("Date filter changed to:", e.target.value);
              // Add logic to refetch data based on date if your APIs support it
              // For now, it just logs. You might need to pass this date to API calls.
              // Example: await loadDashboardData(e.target.value);
              // await fetchAndInitializeCharts(false, e.target.value); // Potentially refetch charts
          });
      }
      document.getElementById('global-logout-btn')?.addEventListener('click', (e) => { 
        e.preventDefault();
        localStorage.removeItem('accessToken');
        openInfoStatusModalOnDashboard("Logged Out", "You have been logged out. Redirecting...", "info", 0);
        setTimeout(() => { window.location.href = LOGIN_PAGE_URL; }, 2000);
      });
      document.getElementById('infoStatusModalOkButton')?.addEventListener('click', closeInfoStatusModalOnDashboard);

      if (!getDashboardAuthToken()) {
          openInfoStatusModalOnDashboard("Authentication Required", "Redirecting to login...", "error", 0);
          setTimeout(() => { window.location.href = LOGIN_PAGE_URL; }, 2500); 
          return; 
      }

      await loadDashboardData();
      await loadRecentActivityListsForDashboard(); 
      await loadTopPerformingDrivers(); 
      await fetchAndInitializeCharts(); 
  });
</script>
</body>
</html>